<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Student Fee Receipt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <!-- Sidebar -->
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column"></nav>
      </div>

      <div class="col main-content">
        <div class="row main-content-area d-flex justify-content-center align-items-start py-5">
          <div class="col-11 bg-white p-5 border rounded-3">
            <h2 class="mb-4">Generate Student Fee Receipt</h2>

            <!-- GR Number Search -->
            <div class="mb-3 row gy-4">
              <div class="col-4">
              <label class=" form-label">Enter GR No</label>

                <input type="number" id="grno" placeholder="Enter GR No" class="form-control" />
              </div>
              <div class="schoolSelect col-4 " id="schoolSelect">

              </div>
              <div class="col-4">
                <button onclick="fetchStudent()" class="btn btn-primary">Get Student</button>
              </div>
            </div>
            <div id="loadingSpinner" class="text-center my-3" style="display: none;">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

            <div class="content">
                <h3 class="text-danger" style="display: none;" id="error">Student Not Found</h3>
            <!-- Student Info -->
            <div id="studentInfo" class="card p-3" style="display:none;">
              <h5>Student Information</h5>
              <div class="row mb-2">
                <div class="col-md-3"><strong>Name:</strong> <span id="name"></span></div>
                <div class="col-md-3"><strong>Father:</strong> <span id="fatherName"></span></div>
                <div class="col-md-3" id="classContainer" style="display: none;"><strong>Class:</strong> <span id="class"></span></div>
                <div class="col-md-3" id="sectionContainer" style="display: none;"><strong>Section:</strong> <span id="section"></span></div>
                <div class="col-md-3" id="computerCourseContainer" style="display: none;"><strong>Computer Course:</strong> <span id="computerCourse"></span></div>
                <div class="col-md-3" id="englishCourseContainer" style="display: none;"><strong>English Course:</strong> <span id="englishCourse"></span></div>
              </div>

              <!-- Fee Details -->
              <div id="feeDetailsContainer"></div>
              <div class="mb-3"><strong>Total Fee:</strong> <span id="totalFee"></span></div>

              <!-- Receipt Input -->
              <h5>Fee Payment Info</h5>
              <div class="row mb-2 align-items-center">
                <div class="col-md-3">
                  <label class="form-label">Month</label>
                  <select id="month" class="form-select">
  <option value="">Select</option>
  <option value="January">January</option>
  <option value="February">February</option>
  <option value="March">March</option>
  <option value="April">April</option>
  <option value="May">May</option>
  <option value="June">June</option>
  <option value="July">July</option>
  <option value="August">August</option>
  <option value="September">September</option>
  <option value="October">October</option>
  <option value="November">November</option>
  <option value="December">December</option>
</select>

                </div>
                <div class="col-md-3">
                  <label class="form-label">Year</label>
                  <input type="number" id="year" class="form-control" placeholder="e.g. 2025" />
                </div>
                 <div class="col-md-3">
                  <button class="btn btn-primary" onclick="addMonth()">Add Month</button>
                </div>
                <div class="col-12">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>month name</th>
                                <th>year</th>
                                <th>action</th>
                            </tr>
                        </thead>
                        <tbody id="monthtbody"></tbody>
                    </table>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Payment Method</label>
                  <select id="paymentMethod" class="form-select">
                    <option value="cash">Cash</option>
                    <option value="online">Online</option>
                  </select>
                </div>
              </div>

              <!-- Payment Type -->
              <div class="mb-3">
                <label class="form-label me-2">Payment Type:</label>
                <input type="radio" name="payType" value="full" checked onclick="toggleAmount()"> Full
                <input type="radio" name="payType" value="balance" class="ms-3" onclick="toggleAmount()"> Balance
              </div>

              <div class="mb-3" id="partialAmountBox" style="display: none;">
                <label class="form-label">Enter Paid Amount</label>
                <input type="number" id="partialAmount" class="form-control" />
              </div>

              <button onclick="submitReceipt()" class="btn btn-success">Submit Receipt</button>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
 const user = JSON.parse(localStorage.getItem("userData")) || [];
  const isSuperAdmin = user[0]?.designation === "superadmin";
  const errorMsg = document.getElementById("error");
  
  
     const sidebar = document.getElementById("sidebar");
var editingStudentId 
const allLinks = {
  // dashboard: { name: "Dashboard", file: "Dashboard.html" },
  addclass: { name: "Add Class", file: "classform.html", active:false },
  addsection: { name: "Add Section", file: "section.html", active:false },
  addschool: { name: "Add School", file: "schoolform.html", active:false },
  addcomputercourse: { name: "Add Computer Course", file: "compcourse.html", active:false },
  addstudent: { name: "Student Form", file: "student.html", active:true },
  studentlist: { name: "Student List", file: "studentlist.html" , active:false},
  feeReceipt: { name: "Fee Receipt", file: "feeReceipt.html" , active:false},
  addteacher: { name: "Teacher Form", file: "teacher.html",  active:false },
  teacherlist: { name: "Teacher List", file: "teacherlist.html" , active:false},
  teacherSalary: { name: "Teacher Salary", file: "teacherSalary.html" , active:false},

  adduser: { name: "Add User", file: "userform.html" , active:false}

};
 if(user.length <= 0){
     window.location.href= 'Dashboard.html'
        
  }

function renderSidebar(user) {
  // console.log(user[0].allowPages)
  // Always show Dashboard and Logout
  sidebar.innerHTML = `<a class='' href="Dashboard.html">Dashboard</a>`;
   if(isSuperAdmin){
  sidebar.innerHTML += `<a href="schoolform.html">Add School</a>`;

  }

  for (const key in allLinks) {
    console.log(key)
    if(isSuperAdmin){
      sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;

    }
    
   else {
   if (user[0].allowedPages.includes(key)) {
      sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;
    }
     else{
        if(allLinks[key].active){
            window.location.href='Dashboard.html'
        }
      }
    }
  }

  sidebar.innerHTML += `<a href="#">Logout</a>`;
}

renderSidebar(user)
   var schoolId 
       schoolId = JSON.parse(localStorage.getItem("userData"))[0]?.school?._id;

 let schoolList = [];

  // ðŸ”½ Inject dropdown if superadmin
  if (isSuperAdmin) {
    const schoolDropdown = document.createElement("select");
    schoolDropdown.className = "form-select mb-3";
    schoolDropdown.id = "schoolDropdown";
    schoolDropdown.required = true;
    schoolDropdown.addEventListener('change', (e)=>{
        schoolId = e.target.value
    })
    const label = document.createElement("label");
    label.textContent = "Select School";
    label.setAttribute("for", "schoolDropdown");
    label.className = "form-label";

    const selectBox = document.getElementById("schoolSelect");
    selectBox.insertBefore(label, selectBox.children[2]); // Insert before fee input
    selectBox.insertBefore(schoolDropdown, selectBox.children[3]);

    // ðŸŸ¢ Fetch and populate schools dropdown
    async function loadSchools() {
      try {
        const res = await axios.get("http://localhost:3000/api/school/get");
        schoolList = res.data.data;
          const option = document.createElement("option");
          option.value = '';
          option.textContent = 'Select School';
          schoolDropdown.appendChild(option);
        schoolList.forEach(school => {
          const option = document.createElement("option");
          option.value = school._id;
          option.textContent = school.name;
          schoolDropdown.appendChild(option);
        });
      } catch (err) {
        console.error("Error fetching schools:", err);
      }
    }

    loadSchools();
  }

    let studentData = null;
    const clonedCard = document.getElementById("studentInfo");
     
 async function fetchStudent() {
  const grno = document.getElementById("grno").value;
  const content = document.querySelector('.content');
  console.log(content)
  const spinner = document.getElementById("loadingSpinner");

  if (spinner) spinner.style.display = 'block';
  errorMsg.style.display= 'none'

  try {
    if (isSuperAdmin) {
      const dropdown = document.getElementById("schoolDropdown");
      schoolId = dropdown?.value;
      if (!schoolId) {
        alert("Please select a school");
        spinner.style.display = 'none';
        return;
      }
    }

    const res = await axios.get(`http://localhost:3000/api/feeReceipt/student/${grno}/${schoolId}`);
    console.log(res.data)
    studentData = res.data;

    // if (!studentData || !studentData._id) {
    //     console.log('here')
    //   content.innerHTML = '<h3 class="text-danger">Student Not Found</h3>';
    //   return;
    // }

    // âœ… Clear and append a cloned version of studentInfo
    console.log(clonedCard)
    if (!clonedCard) throw new Error("studentInfo element not found");

    // const clonedCard = originalCard.cloneNode(true);
    clonedCard.style.display = 'block';

    // content.innerHTML = ''; // Clear previous
    content.appendChild(clonedCard);

    // âœ… Now safely query inside clonedCard
    clonedCard.querySelector("#name").innerText = studentData.name;
    clonedCard.querySelector("#fatherName").innerText = studentData.fatherName;

    clonedCard.querySelector("#classContainer").style.display = 'none';
    clonedCard.querySelector("#sectionContainer").style.display = 'none';
    clonedCard.querySelector("#computerCourseContainer").style.display = 'none';
    clonedCard.querySelector("#englishCourseContainer").style.display = 'none';

    if (studentData.admissionTypes.includes("school") || studentData.admissionTypes.includes("tuition")) {
      clonedCard.querySelector("#classContainer").style.display = 'block';
      clonedCard.querySelector("#class").innerText = studentData.class;
    }
    if (studentData.admissionTypes.includes("school")) {
      clonedCard.querySelector("#sectionContainer").style.display = 'block';
      clonedCard.querySelector("#section").innerText = studentData.section;
    }
    if (studentData.admissionTypes.includes("computer")) {
      clonedCard.querySelector("#computerCourseContainer").style.display = 'block';
      clonedCard.querySelector("#computerCourse").innerText = studentData.computerCourse;
    }
    if (studentData.admissionTypes.includes("english")) {
      clonedCard.querySelector("#englishCourseContainer").style.display = 'block';
      clonedCard.querySelector("#englishCourse").innerText = studentData.englishCourse;
    }

    clonedCard.querySelector("#totalFee").innerText = studentData.totalFee;

    const feeBox = clonedCard.querySelector("#feeDetailsContainer");
    feeBox.innerHTML = "<h6>Fee Details:</h6>";
    for (let type of studentData.admissionTypes) {
      const detail = studentData.feeDetails[type];
      if (detail) {
        feeBox.innerHTML += `
          <div class="fee-box">
            <strong>${type.toUpperCase()} Fee</strong><br/>
            Original Fee: ${detail.originalFee} <br/>
            Discount: ${detail.discount} <br/>
            Payable Fee: <strong>${detail.payableFee}</strong>
          </div>`;
      }
    }

  } catch (err) {
    console.error("Fetch error:", err);
    // content.innerHTML += '<h3 class="text-danger">Student Not Found</h3>';
    clonedCard.style.display = 'none';

    errorMsg.style.display = 'block'
  } finally {
    if (spinner) spinner.style.display = 'none';
    
  }
}



    

    function toggleAmount() {

      const isBalance = document.querySelector('input[name="payType"]:checked').value === 'balance';
      console.log(isBalance)
      console.log( document.getElementById("partialAmountBox"))
      document.getElementById("partialAmountBox").style.display = isBalance ? 'block' : 'none';
      console.log( document.getElementById("partialAmountBox"))

    }



    function submitReceipt() {
     const payType = document.querySelector('input[name="payType"]:checked').value;
const paidAmount = payType === 'full' ? studentData.totalFee : Number(document.getElementById("partialAmount").value);
let schoolId;

if (isSuperAdmin) {
  const dropdown = document.getElementById("schoolDropdown");
  schoolId = dropdown.value;
  if (!schoolId) {
    alert("Please select a school");
    return;
  }
} else {
  schoolId = user[0].school._id;
}

const month = document.getElementById("month").value;
const year = document.getElementById("year").value;

if (months.length <= 0) {
  alert('Please select both month and year');
  return;
}

const data = {
  grno: studentData.grno,
  studentId: studentData._id,
  name: studentData.name,
  fatherName: studentData.fatherName,
  totalFee: studentData.totalFee,
  paymentType: payType,
  paidAmount,
  month,
  year,
  paymentMethod: document.getElementById("paymentMethod").value,
  schoolId
};

axios.post('http://localhost:3000/api/feeReceipt/receipt', data)
  .then(res => {
    alert("Receipt Saved Successfully");
    // window.open(`/print-receipt.html?id=${res.data.receipt._id}`, '_blank');
  })
  .catch(err => {
    alert("Failed to save receipt");
    console.error(err);
  });

    }

    var months = []
    function addMonth(){
        const month = document.getElementById("month").value;
        const year = document.getElementById("year").value;
        if (month === '' || year === '') {
  alert('Please select both month and year');
  return;
}
        months.push({
            name:month,
            year: year
        })
        rendermonths()

    }

    function rendermonths(){
        var tbody = document.getElementById('monthtbody')

        months.map((month , index)=>{
            var row = document.createElement('tr')
            row.innerHTML = `
    <td>${month.name}</td>
    <td>${month.year}</td>
    <td><button type="button" class="btn btn-danger btn-sm delete-month">Delete</button></td>
  `;

  // Add row to table
  tbody.appendChild(row);

  // Add delete functionality
  row.querySelector(".delete-month").addEventListener("click", () => {
    // Remove from array
    months.splice(index, 1);
    // Remove from DOM
    row.remove();

        })
        })
    }
  </script>
</body>
</html>
