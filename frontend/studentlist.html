<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="index.css">
</head>
<style>
       .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: start;
      margin-bottom: 20px;
    }
    input, select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
</style>
<body>
  <div class="container-fluid px-0">
        <div id="navContent"></div>

    <div class="row flex-nowrap">
      <!-- Sidebar -->
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column">
        
        </nav>
      </div>

      <!-- Main Content -->
        <div class="col  main-content ">
        
   <div class="container bg-white mt-4 p-5">
  <h2>Student Data List</h2>

    <div class="mb-3">
      <label class="form-label fw-bold">Select Admission Types:</label><br />
      <div id="admissionTypeContainer">
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="checkbox"
            id="typeSchool"
            value="school"
            
          />
          <label class="form-check-label" for="typeSchool">School</label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="checkbox"
            id="typeComputer"
            value="computer"
          />
          <label class="form-check-label" for="typeComputer">Computer</label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="checkbox"
            id="typeEnglish"
            value="english"
          />
          <label class="form-check-label" for="typeEnglish">English</label>
        </div>
        <div class="form-check form-check-inline">
          <input
            class="form-check-input"
            type="checkbox"
            id="typeTuition"
            value="tuition"
          />
          <label class="form-check-label" for="typeTuition">Tuition</label>
        </div>
      </div>
    </div>

    
<div class="filters mt-4"  >
  <input type="text"  style="display:none;" id="searchInput" placeholder="Search by ID / Name / Class / Section / Campus / Role">

  <select id="campusSelect"  style="display:none;">
    <option value="">All Campuses</option>
  </select>

  <!-- School & Tuition -->
  <select id="classSelect"  style="display:none;">
    <option value="">All Classes</option>
  </select>

  <select id="sectionSelect"  style="display:none;">
    <option value="">All Sections</option>
  </select>

  <!-- Computer Course & Batch -->
  <select id="computerCourseSelect" style="display:none;">
    <option value="">All Computer Courses</option>
  </select>
  <select id="computerBatchSelect" style="display:none;">
    <option value="">All Computer Batches</option>
  </select>

  <!-- English Course & Batch -->
  <select id="englishCourseSelect" style="display:none;">
    <option value="">All English Courses</option>
  </select>
  <select id="englishBatchSelect" style="display:none;">
    <option value="">All English Batches</option>
  </select>
</div>

<button id="exportBtn">Export to Excel</button>

  <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
    <table class="table table-bordered table-hover table-striped align-middle" id="myTable">
      <thead class="table-light sticky-top" id="tableHead">
        <tr>
          <th>Master ID</th>
          <th>GR No</th>
          <th>Class</th>
          <th>Section</th>
          <th>Admission Type</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="studentTableBody"></tbody>
    </table>
  </div>
</div>

      </div>
    </div>
  </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>

    const tbody = document.getElementById("studentTableBody");
//   
  const user = JSON.parse(localStorage.getItem("userData")) || [];

  const isSuperAdmin = user[0]?.designation === "supremeadmin";
  const tableHead = document.getElementById("tableHead");
// const admissionTypeSelect = document.getElementById("admissionTypeSelect");
const classSelect = document.getElementById("classSelect");
const sectionSelect = document.getElementById("sectionSelect");
const computerCourseSelect = document.getElementById("computerCourseSelect");
const computerBatchSelect = document.getElementById("computerBatchSelect");
const englishCourseSelect = document.getElementById("englishCourseSelect");
const englishBatchSelect = document.getElementById("englishBatchSelect");
  const campusSelect = document.getElementById('campusSelect');
var campusId = user[0]?.campusId?._id || null;
var searchInput = document.getElementById("searchInput");
const typeCheckboxes = document.querySelectorAll(
      "#admissionTypeContainer input[type='checkbox']"
    );

    // Helper: Get selected admission types
    function getSelectedTypes() {
      return Array.from(typeCheckboxes)
        .filter((cb) => cb.checked)
        .map((cb) => cb.value);
    }
    

    // Event listeners
    typeCheckboxes.forEach((cb) => cb.addEventListener("change", ()=>{
      searchInput.style.display = "inline-block";
    classSelect.style.display = "none";
    sectionSelect.style.display = "none";
    computerCourseSelect.style.display = "none";
    computerBatchSelect.style.display = "none";
    englishCourseSelect.style.display = "none";
    englishBatchSelect.style.display = "none";
  campusSelect.style.display = 'inline-block';
      searchInput.style.display = "inline-block";
  var selectTypes = getSelectedTypes()
  // Show based on selected type
  if ( selectTypes.includes("school")) {
    
    classSelect.style.display = "inline-block";
    sectionSelect.style.display = "inline-block";
  } 
   if (selectTypes.includes("tuition")) {
    classSelect.style.display = "inline-block";
  } 
   if (selectTypes.includes("computer")) {
    computerCourseSelect.style.display = "inline-block";
    computerBatchSelect.style.display = "inline-block";
  } 
   if (selectTypes.includes("english")) {
    englishCourseSelect.style.display = "inline-block";
    englishBatchSelect.style.display = "inline-block";
  }
applyFilters()
    }));

    // ✅ Apply filters (minimal working version)
    // function applyFilters() {
    //   const selectedTypes = getSelectedTypes();
    //   const filtered = students; // You can add search/campus filter later
    //   renderTable(filtered, selectedTypes);
    // }

    // ✅ Render Table (fixed & minimal)
    function renderTable(data, selectedTypes) {
      tbody.innerHTML = "";

      // Table Header
      let headerHTML = `
        <tr>
          <th>Master ID</th>
          <th>Student Name</th>
          <th>GR No</th>`;

      if (selectedTypes.includes("school")) {
        headerHTML += `<th>Class</th><th>Section</th>`;
      }
      if (selectedTypes.includes("computer")) {
        headerHTML += `<th>Computer Course</th><th>Computer Batch</th>`;
      }
      if (selectedTypes.includes("english")) {
        headerHTML += `<th>English Course</th><th>English Batch</th>`;
      }
      if (selectedTypes.includes("tuition")) {
        headerHTML += `<th>Tuition</th>`;
      }

      headerHTML += `<th>Actions</th></tr>`;
      tableHead.innerHTML = headerHTML;

      if (!data.length) {
        tbody.innerHTML =
          '<tr><td colspan="10" class="text-center">No students found</td></tr>';
        return;
      }

      data.forEach((st) => {
        const gr = st.grNumbers || {};
        let rowHTML = `
          <td>${st.masterId || "N/A"}</td>
          <td>${st.name || "N/A"}</td>
          <td>${[
            gr.school,
            gr.computer,
            gr.english,
            gr.tuition,
          ]
            .filter(Boolean)
            .join(" / ")}</td>`;

        if (selectedTypes.includes("school")) {
          rowHTML += `<td>${st.class?.name || "N/A"}</td><td>${
            st.section?.name || "N/A"
          }</td>`;
        }
        if (selectedTypes.includes("computer")) {
          rowHTML += `<td>${st.computerCourse?.name || "N/A"}</td><td>${
            st.computerCourseBatch?.name || "N/A"
          }</td>`;
        }
        if (selectedTypes.includes("english")) {
          rowHTML += `<td>${st.englishCourse?.name || "N/A"}</td><td>${
            st.engCourseBatch?.name || "N/A"
          }</td>`;
        }
        if (selectedTypes.includes("tuition")) {
          rowHTML += `<td>${st.class?.name || "N/A"}</td>`;
        }

        rowHTML += `
    
          <td>
          <button class="btn btn-info btn-sm" onclick='viewStudent(${JSON.stringify(st)})'>View</button> <button class="btn btn-danger btn-sm" onclick="deleteStudent('${st._id}')">Delete</button>
          </td>`;

        const row = document.createElement("tr");
        row.innerHTML = rowHTML;
        tbody.appendChild(row);
      });
    }





 if(user.length <= 0){
     window.location.href= 'Dashboard.html'
        
  }

var studentList = []

getStudents()
 async function getStudents(){
  if(isSuperAdmin){
       var res= await axios.get(`http://202.143.127.181:3001/api/student/getBySchool/${user[0]?.school._id}`)


  }
  else{
    var res= await axios.get(`http://202.143.127.181:3001/api/student/getByCampus/${user[0]?.school._id}/${user[0]?.campus._id}`)

  }
    console.log(res.data)
      studentList = res.data;
      // renderTable(studentList);

  }

  // admissionTypeSelect.addEventListener("change", applyFilters);
async function loadEngCourses() {
      
      if (!campusId) return;

    try {
      const url =`http://202.143.127.181:3001/api/english-courses/getByCampus/${user[0].school._id}/${campusId}`;
      const res = await axios.get(url);
      engCourses = res.data.data;
      console.log(engCourses)
      englishCourseSelect.innerHTML = `<option value="">Select Course</option>`;
      engCourses.forEach(course => {
        const option = document.createElement("option");
        option.value = course._id;
        option.textContent = course.name;

        englishCourseSelect.appendChild(option);
      });
    } catch (err) {
      console.error("Error loading computer courses:", err);
    }
  }

  


    // Load Classes
    async function loadClasses() {  
        console.log(campusId)
      if (!campusId) return;
     

      try {
        const url =  `http://202.143.127.181:3001/api/class/getByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allClasses = res.data.data;
        classSelect.innerHTML = `<option value="">Select Class</option>`;
        // tuitionclass.innerHTML = `<option value="">Select Class</option>`;

        allClasses.forEach(cls => {
          const option = document.createElement("option");
          option.value = cls._id;
          option.textContent = cls.name;
          option.setAttribute("data-id", cls._id); // store ID in data attribute

          classSelect.appendChild(option);
        });
          //    allClasses.forEach(cls => {
          // const option = document.createElement("option");
          // option.value = cls._id;
          // option.textContent = cls.name;
          // option.setAttribute("data-id", cls._id); // store ID in data attribute

          // tuitionclass.appendChild(option);
        // });
      } catch (err) {
        console.error("Error loading classes:", err);
      }
    }

    // Load Sections (independent of class)
    async function loadSections() {
      if (!campusId) return;
    
      try {
        const url =  `http://202.143.127.181:3001/api/section/getByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allSections = res.data.data;
        sectionSelect.innerHTML = `<option value="">Select Section</option>`;
        allSections.forEach(sec => {
          const option = document.createElement("option");
          option.value = sec._id;
          option.textContent = sec.name;
          sectionSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading sections:", err);
      }
    }

    // Load Computer Courses
    async function loadCourses() {
      if (!campusId) return;
     
      try {
        const url = `http://202.143.127.181:3001/api/course/getbyCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allCourses = res.data.data;
        computerCourseSelect.innerHTML = `<option value="">Select Course</option>`;
        allCourses.forEach(course => {
          const option = document.createElement("option");
          option.value = course._id;
          option.textContent = course.name;
          option.setAttribute("data-id", course._id); // store ID in data attribute

          computerCourseSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }

    

// Function to handle computer course batch population
function updateComputerCourseBatches() {
  const selectedCourseId = computerCourseSelect.value;
  const selectedCourse = allCourses.find(c => c._id === selectedCourseId);

  if (selectedCourse) {
    const batches = allComputerBatches.filter(
      b => b.courseName.name === selectedCourse.name
    ) || [];

    computerBatchSelect.innerHTML = `<option value="">Select Batch</option>`;

    batches.forEach(batch => {
      const option = document.createElement("option");
      option.value = batch._id;
      option.textContent = batch.name;
      computerBatchSelect.appendChild(option);
    });
  } else {
    computerBatchSelect.innerHTML = `<option value="">Select Batch</option>`;
  }
}

// Function to handle English course batch population
function updateEnglishCourseBatches() {
  const selectedCourseId = englishCourseSelect.value;
  const selectedCourse = engCourses.find(c => c._id === selectedCourseId);

  if (selectedCourse) {
    const batches = allEnglishBatches.filter(
      b => b.courseName.name === selectedCourse.name
    ) || [];

    englishBatchSelect.innerHTML = `<option value="">Select Batch</option>`;

    batches.forEach(batch => {
      const option = document.createElement("option");
      option.value = batch._id;
      option.textContent = batch.name;
      englishBatchSelect.appendChild(option);
    });
  } else {
    englishBatchSelect.innerHTML = `<option value="">Select Batch</option>`;
  }
}

// Event listeners
computerCourseSelect.addEventListener('change', updateComputerCourseBatches);
englishCourseSelect.addEventListener('change', updateEnglishCourseBatches);

  

    if(isSuperAdmin){
      loadCampuses()
      var selectTypes = getSelectedTypes()
      if(selectTypes.length > 0){
        campusSelect.style.display = 'inline-block'
      }
      else{
        campusSelect.style.display = 'none'

      }
      // campusSelect.style.display = 'inline-block'
    }
    else{
      campusSelect.style.display = 'none'

    }
    function loadCampuses() {
      return axios.get(`http://202.143.127.181:3001/api/campus/getBySchool/${user[0].school._id}`)
        .then(response => {
          const campuses = response.data;
          console.log(campuses)
          campuses.forEach(campus => {
            const option = document.createElement('option');
            option.value = campus._id; // Use campus name as value
            option.textContent = campus.name;
            campusSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error loading campuses:', error);
        });
    }

// Example view and delete functions
function viewStudent(data) {
  localStorage.setItem("viewStudentData", JSON.stringify(data));
  window.location.href = "student.html?view=true";
}

async function deleteStudent(id) {
  if (!confirm("Are you sure you want to delete this student?")) return;
  await axios.delete(`http://202.143.127.181:3001/api/student/delete/${id}`);
  studentList = studentList.filter((st) => st._id !== id);
  renderTable();
}

   var allComputerBatches = []
    async function loadComputerBatches(){
      if (!campusId) return;
      try {
        const url = `http://202.143.127.181:3001/api/batch/getAllComputerBatchesByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allComputerBatches = res.data.data;
        console.log(allComputerBatches)
        
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }

    var allEnglishBatches = []
     async function loadEnglishBatches(){
      if (!campusId) return;
      try {
        const url = `http://202.143.127.181:3001/api/batch/getAllEnglishBatchesByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allEnglishBatches = res.data.data;
       
        
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }


function applyFilters() {
  const selectedTypes = getSelectedTypes();
  const search = searchInput.value.toLowerCase();
  const selectedCampus = campusSelect.value;

  const selectedClass = classSelect.value;
  const selectedSection = sectionSelect.value;
  const selectedComputerCourse = computerCourseSelect.value;
  const selectedComputerBatch = computerBatchSelect.value;
  const selectedEnglishCourse = englishCourseSelect.value;
  const selectedEnglishBatch = englishBatchSelect.value;

  const filtered = studentList.filter(student => {
    const gr = student.grNumbers || {};

    // 🔹 Match any GR number for selected admission types
    let matchesGr = false;
    selectedTypes.forEach(type => {
      if (type === "school" && gr.school?.toLowerCase().includes(search)) matchesGr = true;
      if (type === "computer" && gr.computer?.toLowerCase().includes(search)) matchesGr = true;
      if (type === "english" && gr.english?.toLowerCase().includes(search)) matchesGr = true;
      if (type === "tuition" && gr.tuition?.toLowerCase().includes(search)) matchesGr = true;
    });

    // 🔹 General search match
    const matchesSearch =
      !search ||
      student.masterId?.toLowerCase().includes(search) ||
      student.name?.toLowerCase().includes(search) ||
      student.fatherName?.toLowerCase().includes(search) ||
      student.class?.name?.toLowerCase().includes(search) ||
      student.section?.name?.toLowerCase().includes(search) ||
      matchesGr;

    const matchesCampus = !selectedCampus || student.campusId?._id === selectedCampus;

    // 🔹 Admission-type-specific dropdown filters
    let matchesClass = true;
    let matchesSection = true;
    let matchesComputerCourse = true;
    let matchesComputerBatch = true;
    let matchesEnglishCourse = true;
    let matchesEnglishBatch = true;

    if (selectedTypes.includes("school") || selectedTypes.includes("tuition")) {
      matchesClass = !selectedClass || student.class?._id === selectedClass;
    }
    if (selectedTypes.includes("school")) {
      matchesSection = !selectedSection || student.section?._id === selectedSection;
    }
    if (selectedTypes.includes("computer")) {
      matchesComputerCourse = !selectedComputerCourse || student.computerCourse?._id === selectedComputerCourse;
      matchesComputerBatch = !selectedComputerBatch || student.computerCourseBatch?._id === selectedComputerBatch;
    }
    if (selectedTypes.includes("english")) {
      matchesEnglishCourse = !selectedEnglishCourse || student.englishCourse?._id === selectedEnglishCourse;
      matchesEnglishBatch = !selectedEnglishBatch || student.engCourseBatch?._id === selectedEnglishBatch;
    }

    return (
      matchesSearch &&
      matchesCampus &&
      matchesClass &&
      matchesSection &&
      matchesComputerCourse &&
      matchesComputerBatch &&
      matchesEnglishCourse &&
      matchesEnglishBatch
    );
  });

  renderTable(filtered, selectedTypes);
}


    // Event Listeners
    searchInput.addEventListener('input', applyFilters);
    sectionSelect.addEventListener('change', applyFilters);
    classSelect.addEventListener('change', applyFilters); 
    computerCourseSelect.addEventListener('change', ()=>{
      updateComputerCourseBatches();
      applyFilters();
    });
    computerBatchSelect.addEventListener('change', applyFilters);
    englishCourseSelect.addEventListener('change', ()=>{
      updateEnglishCourseBatches();
      applyFilters();
    });
    englishBatchSelect.addEventListener('change', applyFilters);
  
    campusSelect.addEventListener('change', ()=>{
      campusId = campusSelect.value;
      console.log(campusId)
      loadClasses();
      loadSections();
      loadCourses();
      loadEngCourses();
      loadComputerBatches();
      loadEnglishBatches();
      applyFilters();
    });
    // roleSelect.addEventListener('change', applyFilters);
//  document.getElementById("exportBtn").addEventListener("click", () => {
//     const table = document.getElementById("myTable");
//     let csv = [];
//     for (let row of table.rows) {
//       let cells = Array.from(row.cells).map(cell => `"${cell.innerText}"`);
//       csv.push(cells.join(","));
//     }

//     const blob = new Blob([csv.join("\n")], { type: "text/csv" });
//     const url = URL.createObjectURL(blob);

//     const a = document.createElement("a");
//     a.href = url;
//     a.download = "table-data.csv";
//     a.click();
//   });

  document.getElementById("exportBtn").addEventListener("click", () => {
    const table = document.getElementById("myTable");
    const workbook = XLSX.utils.table_to_book(table, { sheet: "Sheet 1" });
    XLSX.writeFile(workbook, "table-data.xlsx");
  })

  </script>
<script src="index.js"></script>

</body>
</html>
