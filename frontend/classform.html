<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard- Class form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
    <style>
       .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
    </style>
</head>

<body>
  
                  <div class="container-fluid">
    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column"></nav>
      </div>

      <div class="col main-content">
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-5 mb-5 border rounded-3">
            <h2 class="mb-4">Add Class</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addClassModal">Add New Class</button>

            <h4>All Classes</h4>
            <div class="row">
              <div class="col-3">
                <label for="">Enter Name</label>
            <input type="text" class="form-control " placeholder="Search by Class Name" id="searchClass">
              </div>
              <div class="col-3" id="schoolSelectBox1">
            

              </div>
            </div>
            <div class="table-responsive mt-3" style="max-height: 600px; overflow-y: auto;">
              <table class="table table-bordered table-hover" id="classTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Class Name</th>
                    <th>Class Fee</th>
                    <th>Tuition Fee</th>
                    <th>Admission Fee</th>
                    <th id="adminth" style="display: none;">School</th>

                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="width: 100%; max-width: 600px; margin: auto;">
        <form id="classForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addClassModalLabel">Add New Class</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="schoolDropdownContainer"></div>
            <div class="mb-3">
              <label class="form-label">Class Name</label>
              <input type="text" class="form-control" id="className" placeholder="Enter class name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Class Fee</label>
              <input type="number" class="form-control" id="classFee" placeholder="Enter class fee" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Tuition Fee</label>
              <input type="number" class="form-control" id="tuitionFee" placeholder="Enter tuition fee" required>
            </div>
              <div class="mb-3">
              <label class="form-label">Admission Fee</label>
              <input type="number" class="form-control" id="admissionFee" placeholder="Enter Admission fee" required>
            </div>
               <div class="mb-3" id="schoolSelectBox2">
                
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="formSubmitBtn">Add Class</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <!-- <script src="./dashboard.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const classNameInput = document.getElementById("className");
  const classFeeInput = document.getElementById("classFee");
  const tuitionFeeInput = document.getElementById("tuitionFee");
  const admissionFeeInput = document.getElementById('admissionFee')
  const addButton = document.getElementById("formSubmitBtn");
  const tableBody = document.querySelector("#classTable tbody");
  const classForm = document.getElementById('classForm')
  const adminTh = document.getElementById('adminth')
  
  const user = JSON.parse(localStorage.getItem("userData")) || [];

  const modal = new bootstrap.Modal(document.getElementById("addClassModal"));

const toast = new bootstrap.Toast(document.getElementById("toastMessage"));
const toastBody = document.getElementById("toastBody");
const toastElement = document.getElementById("toastMessage");
const searchSchoolInput = document.getElementById('searchClass')
function showToast(message, isSuccess = true) {
  console.log('toast is working')
  toastBody.textContent = message;
  toastElement.classList.remove("bg-success", "bg-danger");
  toastElement.classList.add(isSuccess ? "bg-success" : "bg-danger");
  toast.show();
}
let isEditing = false;
let editingId = null;

  console.log(user)
  const isSuperAdmin = user[0]?.designation === "superadmin";
  console.log(isSuperAdmin)
const sidebar = document.getElementById("sidebar");

const allLinks = {
  // dashboard: { name: "Dashboard", file: "Dashboard.html" },
  addclass: { name: "Add Class", file: "classform.html", active:true },
  addsection: { name: "Add Section", file: "section.html", active:false },
  addcomputercourse: { name: "Add Computer Course", file: "compcourse.html", active:false },
  addenglangcourse: { name: "Add English lang Course", file: "englangcourse.html", active:false },

  addstudent: { name: "Student Form", file: "student.html", active:false },
  studentlist: { name: "Student List", file: "studentlist.html" , active:false},
  addteacher: { name: "Teacher Form", file: "teacher.html",  active:false},
  teacherlist: { name: "Teacher List", file: "teacherlist.html" , active:false},
  teacherSalary: { name: "Teacher Salary", file: "teacherSalary.html" , active:false},
  adduser: { name: "Add User", file: "userform.html" , active:false}



};
if(user.length > 0 || !user == null){
function renderSidebar(user) {
  // console.log(user[0].allowPages)
  // Always show Dashboard and Logout
  sidebar.innerHTML = `<a class='active' href="Dashboard.html">Dashboard</a>`;
   if(isSuperAdmin){
  sidebar.innerHTML += `<a href="schoolform.html">Add School</a>`;

  }

  for (const key in allLinks) {
    console.log(key)
    if(isSuperAdmin){
      sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;

    }
    
   else {
   if (user[0].allowedPages.includes(key)) {
      sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;
    }
     else{
        if(allLinks[key].active){
            window.location.href='Dashboard.html'
        }
      }
    }
  }

  sidebar.innerHTML += `<a href="#">Logout</a>`;
}

renderSidebar(user);
  let originalClassList = []
  let classList = [];
  let schoolList = [];
  var schoolSelectBox1 = document.getElementById('schoolSelectBox1')
  var schoolSelectBox2 = document.getElementById('schoolSelectBox2')
  // ðŸ”½ Inject dropdown if superadmin
  if (isSuperAdmin) {
    const schoolDropdown = document.createElement("select");
    schoolDropdown.className = "form-select mb-3";
    schoolDropdown.id = "schoolDropdown";
    schoolDropdown.required = true;

    const label = document.createElement("label");
    label.textContent = "Select School";
    label.setAttribute("for", "schoolDropdown");
    label.className = "form-label";

    const schoolDropdownfilter = document.createElement("select");
    schoolDropdownfilter.className = "form-select mb-3";
    schoolDropdownfilter.id = "schoolDropdownfilter";
    schoolDropdownfilter.required = true;

    const label2 = document.createElement("label");
    label2.textContent = "Select School";
    label2.setAttribute("for", "schoolDropdown");
    label2.className = "form-label";

    const form = document.getElementById("classForm");
    schoolSelectBox1.appendChild(label2)
    schoolSelectBox1.appendChild(schoolDropdownfilter)

        schoolSelectBox2.appendChild(label)
      schoolSelectBox2.appendChild(schoolDropdown)
    // ðŸŸ¢ Fetch and populate schools dropdown
    async function loadSchools() {
      try {
        const res = await axios.get("http://localhost:3000/api/school/get");
        schoolList = res.data.data;
               const option = document.createElement("option");
          option.value = "";
          option.textContent = 'Select School';
          schoolDropdown.appendChild(option);
        schoolList.forEach(school => {
          const option = document.createElement("option");
          option.value = school._id;
          option.textContent = school.name;
          schoolDropdown.appendChild(option);
        });

          const option2 = document.createElement("option");
          option2.value = "";
          option2.textContent = 'Select School';
          schoolDropdownfilter.appendChild(option2);
        schoolList.forEach(school => {
          const option2 = document.createElement("option");
          option2.value = school._id;
          option2.textContent = school.name;
          schoolDropdownfilter.appendChild(option2);
        });
      } catch (err) {
        console.error("Error fetching schools:", err);
      }
    }

    loadSchools();
  }

  // ðŸ” Load classes on page load
  window.addEventListener("DOMContentLoaded", loadClasses);

  async function loadClasses() {
    try {
      let res;
      if (isSuperAdmin) {
        res = await axios.get("http://localhost:3000/api/class/all");
      } else {
        res = await axios.get(`http://localhost:3000/api/class/getBySchool/${user[0].school._id}`);
      }
      classList = res.data.data;
      originalClassList = [...res.data.data]
      renderTable();
    } catch (err) {
      console.error("Error loading classes:", err);
    }
  }

  function renderTable() {
    tableBody.innerHTML = "";
      adminTh.style.display =  isSuperAdmin ?'block' : 'none'

    console.log(classList)
    if (classList.length > 0) {
    console.log(classList)

      classList.forEach((cls, i) => {
        console.log( cls)
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${cls.name}</td>
          <td>${cls.fee}</td>
          <td>${cls.tuitionFee}</td>
          <td>${cls.admissionFee || 'N/A'}</td>
             <td>
    ${
      isSuperAdmin
        ? 
          
            cls.schoolId.name
          
        : ''
    }
  </td>
          <td>
        <button class="btn btn-sm btn-info me-1" onclick="editClass('${cls._id}')">Edit</button>

            <button class="btn btn-sm btn-danger" onclick="deleteClass('${cls._id}')">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    } else {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No classes found</td></tr>`;
    }
  }

  async function deleteClass(id) {
      if (!confirm("Are you sure you want to delete this school?")) return;

    try {
     var res = await axios.delete(`http://localhost:3000/api/class/delete/${id}`);
      classList = classList.filter(cls => cls._id !== id);
originalClassList = originalClassList.filter(cls => cls._id !== id);
    showToast(res.data.message || "Deleted successfully");

      renderTable();
    } catch (err) {
      console.error("Failed to delete class:", err);
    showToast("Failed to delete school", false);

    }
  }

  // âž• Add Class
  addButton.addEventListener("click", async (e) => {
    e.preventDefault();

    const name = classNameInput.value.trim();
    const fee = classFeeInput.value.trim();
    const tuitionFee = tuitionFeeInput.value.trim();
    const admissionFee = admissionFeeInput.value.trim();

    if (!name || !fee || !tuitionFee || !admissionFee) {
      alert("Please fill all fields");
      return;
    }

    let schoolId;

    if (isSuperAdmin) {
      const dropdown = document.getElementById("schoolDropdown");
      schoolId = dropdown.value;
      if (!schoolId) {
        alert("Please select a school");
        return;
      }
    } else {
      schoolId = user[0].school._id;
    }

    try {
       if (isEditing) {
      const res = await axios.put(`http://localhost:3000/api/class/update/${editingId}`, {
        name, fee, tuitionFee,admissionFee,schoolId
      });

      const { data, message } = res.data;
      const index = classList.findIndex(s => s._id === editingId);
      classList[index] = data;
      originalClassList[index] = data;

      showToast(message || "School updated successfully");

    } else {
      const res = await axios.post("http://localhost:3000/api/class/add", {
        name, fee, tuitionFee,admissionFee,schoolId
      });

      const { data, message } = res.data;
      showToast(message, data && data._id);
      console.log(data,message)
      // Only push if school added
      if (data && data._id) {
        classList.push(data);
        originalClassList.push(data)
      }
      console.log(classList)
      console.log(originalClassList)

      // Don't close modal if already exists
      if (message === "School Already Exists") return;
    }

    // Reset and close modal
    isEditing = false;
    editingId = null;
    classForm.reset();
    addButton.textContent = "Add School";
    document.getElementById("addClassModalLabel").textContent = "Add New School";
    modal.hide();


      if (isSuperAdmin) document.getElementById("schoolDropdown").value = "";

      renderTable();
    } catch (err) {
      console.error("Error adding class:", err);
      alert("Failed to add class");
    }
  });

  // ðŸ—‘ Expose delete globally
  window.deleteClass = deleteClass;


  window.editClass = function (id) {
  const classData = classList.find(s => s._id === id);
  if (!classData) {
    showToast("Class not found", false);
    return;
  }

  isEditing = true;
  editingId = id;
  classNameInput.value = classData.name;
  classFeeInput.value = classData.fee;
  tuitionFeeInput.value = classData.tuitionFee;
  admissionFeeInput.value = classData.admissionFee
  if(isSuperAdmin) document.getElementById('schoolDropdown').value = classData.schoolId._id

  document.getElementById("addClassModalLabel").innerText = "Update School";
  formSubmitBtn.innerText = "Update School";
  modal.show();
}
let selectedSchoolId = ''; // Store selected school
let filteredClasses = originalClassList;

// ðŸ‘‡ Search filter
searchSchoolInput.addEventListener('input', () => {
  const searchTerm = searchSchoolInput.value.toLowerCase().trim();

  // Apply both filters: school + search text
  filteredClasses = originalClassList.filter(cls =>
    (selectedSchoolId === '' || cls.schoolId._id === selectedSchoolId) &&
    cls.name.toLowerCase().includes(searchTerm)
  );

  classList = filteredClasses;
  renderTable();
});

// ðŸ‘‡ School dropdown filter
if (isSuperAdmin) {
  document.getElementById('schoolDropdownfilter').addEventListener('change', (e) => {
    selectedSchoolId = e.target.value; // Save selected school

    const searchTerm = searchSchoolInput.value.toLowerCase().trim();

    // Apply both filters: school + search text
    filteredClasses = originalClassList.filter(cls =>
      (selectedSchoolId === '' || cls.schoolId._id === selectedSchoolId) &&
      cls.name.toLowerCase().includes(searchTerm)
    );

    classList = filteredClasses;
    renderTable();
  });
}

document.getElementById("addClassModal").addEventListener("hidden.bs.modal", closeModal);


function closeModal() {
  classForm.reset();
  isEditing = false;
  editingId = null;
  formSubmitBtn.textContent = "Add School";
  document.getElementById("addClassModalLabel").textContent = "Add New School";
}

}

else{
             window.location.href='Dashboard.html'

}



// 
</script>

</body>

</html>