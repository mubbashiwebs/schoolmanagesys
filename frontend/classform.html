<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard- Class form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
    <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
/>

    <style>
       .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
    </style>
    <style>
  
</style>
</head>

<body>
  
                  <div class="container-fluid ">

                    <div class="row " id="navContent">
                      
                    </div>
        

    <div class="row flex-wrap">
      <div class="col-auto col-md-3 col-xl-2  px-sm-2 px-0 sidebar ">
        <!-- <h4>Admin Panel</h4> -->
        <nav id="sidebar" class="nav flex-column  "></nav>
      </div>

      <div class="col  ">
        <div class="row mt-md-0  ">
          <div class="col col-12 bg-white p-5  border rounded-3">
            <h2 class="mb-4">Add Class</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addClassModal">Add New Class</button>

            <h4>All Classes</h4>
            <div class="row">
              <div class="col-3">
                <label for="">Enter Name</label>
            <input type="text" class="form-control " placeholder="Search by Class Name" id="searchClass">
              </div>
              <div class="col-3" id="campusSelectBox1">
            

              </div>
            </div>
            <div class="table-responsive mt-3" style="max-height: 600px; overflow-y: auto;">
              <table class="table table-bordered table-hover" id="classTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Class Name</th>
                    <th>Class Fee</th>
                    <th>Tuition Fee</th>
                    <th>Admission Fee</th>
                    <th id="adminth" style="display: none;">campus</th>

                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
<div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm border-0 rounded-3" style="width: 100%; max-width: 600px; margin: auto;">
      <form id="classForm">
        <!-- Modal Header -->
        <div class="modal-header border-0">
          <h5 class="modal-title fw-semibold" id="addClassModalLabel">Add New Class</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
          <div id="campusDropdownContainer" class="mb-3"></div>

          <!-- Row 1 -->
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small">Class Name</label>
              <input type="text" class="form-control minimalist-input" id="className" placeholder="Enter class name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Class Fee</label>
              <input type="number" class="form-control minimalist-input" id="classFee" placeholder="Enter class fee" required>
            </div>
          </div>

          <!-- Row 2 -->
          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label small">Tuition Fee</label>
              <input type="number" class="form-control minimalist-input" id="tuitionFee" placeholder="Enter tuition fee" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Admission Fee</label>
              <input type="number" class="form-control minimalist-input" id="admissionFee" placeholder="Enter admission fee" required>
            </div>
              
          </div>

          <!-- Optional Campus Select -->
          <div class="mt-3" id="campusSelectBox2"></div>
        </div>

        <!-- Modal Footer -->
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-dark px-4" id="formSubmitBtn">Add Class</button>
        </div>
      </form>
    </div>
  </div>
</div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
        crossorigin="anonymous"></script>
    <!-- <script src="./dashboard.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  const classNameInput = document.getElementById("className");
  const classFeeInput = document.getElementById("classFee");
  const tuitionFeeInput = document.getElementById("tuitionFee");
  const admissionFeeInput = document.getElementById('admissionFee')
  const addButton = document.getElementById("formSubmitBtn");
  const tableBody = document.querySelector("#classTable tbody");
  const classForm = document.getElementById('classForm')
  const adminTh = document.getElementById('adminth')
  // const teacherIdInput = document.getElementById("teacherId");
  //     const teacherName = document.getElementById("teachername");
  const user = JSON.parse(localStorage.getItem("userData")) || [];

  const modal = new bootstrap.Modal(document.getElementById("addClassModal"));

const toast = new bootstrap.Toast(document.getElementById("toastMessage"));
const toastBody = document.getElementById("toastBody");
const toastElement = document.getElementById("toastMessage");
const searchcampusInput = document.getElementById('searchClass')
function showToast(message, isSuccess = true) {
  console.log('toast is working')
  toastBody.textContent = message;
  toastElement.classList.remove("bg-success", "bg-danger");
  toastElement.classList.add(isSuccess ? "bg-success" : "bg-danger");
  toast.show();
}
let isEditing = false;
let editingId = null;

  console.log(user)
  const isSuperAdmin = user[0]?.designation === "supremeadmin";
  console.log(isSuperAdmin)

  // var classTeacherId
// const sidebar = document.getElementById("sidebar");

// const allLinks = {
//   // dashboard: { name: "Dashboard", file: "Dashboard.html" },
//   addclass: { name: "Add Class", file: "classform.html", active:true },
//   addsection: { name: "Add Section", file: "section.html", active:false },
//   addcomputercourse: { name: "Add Computer Course", file: "compcourse.html", active:false },
//   addenglangcourse: { name: "Add English lang Course", file: "englangcourse.html", active:false },

//   addstudent: { name: "Student Form", file: "student.html", active:false },
//   studentlist: { name: "Student List", file: "studentlist.html" , active:false},
//   addteacher: { name: "Teacher Form", file: "teacher.html",  active:false},
//   teacherlist: { name: "Teacher List", file: "teacherlist.html" , active:false},
//   teacherSalary: { name: "Teacher Salary", file: "teacherSalary.html" , active:false},
//   adduser: { name: "Add User", file: "userform.html" , active:false}



// };
if(user.length > 0 || !user == null){
// function renderSidebar(user) {
//   // console.log(user[0].allowPages)
//   // Always show Dashboard and Logout
//   sidebar.innerHTML = `<a class='active' href="Dashboard.html">Dashboard</a>`;
//    if(isSuperAdmin){
//   sidebar.innerHTML += `<a href="campusform.html">Add campus</a>`;

//   }

//   for (const key in allLinks) {
//     console.log(key)
//     if(isSuperAdmin){
//       sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;

//     }
    
//    else {
//    if (user[0].allowedPages.includes(key)) {
//       sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;
//       if(allLinks[key].active){
//         checkPermission(key)
//       }
//     }
//      else{
//         if(allLinks[key].active){
//             window.location.href='Dashboard.html'
//         }
//       }
//     }
//   }

//   sidebar.innerHTML += `<a href="#">Logout</a>`;
// }
const permissions = [{page: 'addclass',  permissions: ['read']},
{page: 'addsection', permissions: ['read']}
]

function checkPermission(currentPage){
  console.log(currentPage)
  const currentPagePerm= permissions.find(p=> p.page === currentPage)
  console.log(currentPagePerm)
  
  // permissions.forEach(permission => {
  //   if(permission.page== currentPage ){
  //     if(permission.permissions.includes('read')){
  //       console
  //     }
  //   }
  // });
}
// 
// renderSidebar(user);
  let originalClassList = []
  let classList = [];
  // let campusList = [];
  // var campusSelectBox1 = document.getElementById('campusSelectBox1')
  // var campusSelectBox2 = document.getElementById('campusSelectBox2')
  // // 🔽 Inject dropdown if superadmin
  // if (isSuperAdmin) {
  //   const campusDropdown = document.createElement("select");
  //   campusDropdown.className = "form-select mb-3";
  //   campusDropdown.id = "campusDropdown";
  //   campusDropdown.required = true;

  //   const label = document.createElement("label");
  //   label.textContent = "Select campus";
  //   label.setAttribute("for", "campusDropdown");
  //   label.className = "form-label";

  //   const campusDropdownfilter = document.createElement("select");
  //   campusDropdownfilter.className = "form-select mb-3";
  //   campusDropdownfilter.id = "campusDropdownfilter";
  //   campusDropdownfilter.required = true;

  //   const label2 = document.createElement("label");
  //   label2.textContent = "Select campus";
  //   label2.setAttribute("for", "campusDropdown");
  //   label2.className = "form-label";

  //   const form = document.getElementById("classForm");
  //   campusSelectBox1.appendChild(label2)
  //   campusSelectBox1.appendChild(campusDropdownfilter)

  //   campusSelectBox2.appendChild(label)
  //   campusSelectBox2.appendChild(campusDropdown)
  //   // 🟢 Fetch and populate campuses dropdown
  //   async function loadcampuses() {
  //     try {
  //       const res = await axios.get(`http://202.143.127.181:3001/api/campus/getBySchool/${user[0].school._id}`);
  //       campusList = res.data;
  //       console.log(campusList)
  //              const option = document.createElement("option");
  //         option.value = "";
  //         option.textContent = 'Select campus';
  //         campusDropdown.appendChild(option);
  //       campusList.forEach(campus => {
  //         const option = document.createElement("option");
  //         option.value = campus._id;
  //         option.textContent = campus.name;
  //         campusDropdown.appendChild(option);
  //       });

  //         const option2 = document.createElement("option");
  //         option2.value = "";
  //         option2.textContent = 'Select campus';
  //         campusDropdownfilter.appendChild(option2);
  //       campusList.forEach(campus => {
  //         const option2 = document.createElement("option");
  //         option2.value = campus._id;
  //         option2.textContent = campus.name;
  //         campusDropdownfilter.appendChild(option2);
  //       });
  //     } catch (err) {
  //       console.error("Error fetching campuses:", err);
  //     }
  //   }

  //   loadcampuses();
  // }

  // 🔁 Load classes on page load
  window.addEventListener("DOMContentLoaded", loadClasses);

  async function loadClasses() {
    try {
      let res;
      if (isSuperAdmin) {
        res = await axios.get(`http://202.143.127.181:3001/api/class/school/${user[0].school._id}`);
      } else {
        res = await axios.get(`http://202.143.127.181:3001/api/class/getByCampus/${user[0].school._id}/${user[0].campus._id}`);
      }
      classList = res.data.data;
      console.log(classList);
      originalClassList = [...res.data.data]
      renderTable();
    } catch (err) {
      console.error("Error loading classes:", err);
    }
  }

  function renderTable() {
    tableBody.innerHTML = "";
      adminTh.style.display =  isSuperAdmin ?'block' : 'none'

    console.log(classList)
    if (classList.length > 0) {
    console.log(classList)

      classList.forEach((cls, i) => {
        console.log( cls)
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${cls.name}</td>
          <td>${cls.fee}</td>
          <td>${cls.tuitionFee}</td>
          <td>${cls.admissionFee || 'N/A'}</td>
                 ${isSuperAdmin ? `<td>${cls.campusId?.name || 'N/A'}</td>` : ''}

          <td>
        <button class="btn btn-sm btn-info me-1" onclick="editClass('${cls._id}')">Edit</button>

            <button class="btn btn-sm btn-danger" onclick="deleteClass('${cls._id}')">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    } else {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No classes found</td></tr>`;
    }
  }

  async function deleteClass(id) {
      if (!confirm("Are you sure you want to delete this campus?")) return;

    try {
     var res = await axios.delete(`http://202.143.127.181:3001/api/class/delete/${id}`);
      classList = classList.filter(cls => cls._id !== id);
originalClassList = originalClassList.filter(cls => cls._id !== id);
    showToast(res.data.message || "Deleted successfully");

      renderTable();
    } catch (err) {
      console.error("Failed to delete class:", err);
    showToast("Failed to delete campus", false);

    }
  }

  // ➕ Add Class
  addButton.addEventListener("click", async (e) => {
    e.preventDefault();

    const name = classNameInput.value.trim();
    const fee = classFeeInput.value.trim();
    const tuitionFee = tuitionFeeInput.value.trim();
    const admissionFee = admissionFeeInput.value.trim();

    if (!name || !fee || !tuitionFee || !admissionFee) {
      alert("Please fill all fields");
      return;
    }

    let campusId;
    let schoolId = user[0]?.school?._id;
    const createdBy = user[0]._id
        if (isSuperAdmin) {
      const dropdown = document.getElementById("campusDropdown");
      campusId = dropdown.value;
      if (!campusId) {
        alert("Please select a campus");
        return;
      }
    } else {
      campusId = user[0].campus._id;
    }

    try {
       if (isEditing) {
      const res = await axios.put(`http://202.143.127.181:3001/api/class/update/${editingId}`, {
        name, fee, tuitionFee,admissionFee,campusId , schoolId 
      });

      const { data, message } = res.data;
      const index = classList.findIndex(s => s._id === editingId);
      classList[index] = data;
      originalClassList[index] = data;

      showToast(message || "campus updated successfully");

    } else {
      const res = await axios.post("http://202.143.127.181:3001/api/class/add", {
        name, fee, tuitionFee,admissionFee,campusId , schoolId , createdBy
      });

      const { data, message } = res.data;
      showToast(message, data && data._id);
      console.log(data,message)
      // Only push if campus added
      if (data && data._id) {
        classList.push(data);
        originalClassList.push(data)
      }
      console.log(classList)
      console.log(originalClassList)

      // Don't close modal if already exists
      if (message === "campus Already Exists") return;
    }

    // Reset and close modal
    isEditing = false;
    editingId = null;
    classForm.reset();
    addButton.textContent = "Add campus";
    document.getElementById("addClassModalLabel").textContent = "Add New campus";
    modal.hide();


      if (isSuperAdmin) document.getElementById("campusDropdown").value = "";

      renderTable();
    } catch (err) {
      console.error("Error adding class:", err);
      alert("Failed to add class");
    }
  });

  // 🗑 Expose delete globally
  window.deleteClass = deleteClass;


  window.editClass = function (id) {
  const classData = classList.find(s => s._id === id);
  if (!classData) {
    showToast("Class not found", false);
    return;
  }

  isEditing = true;
  editingId = id;
  classNameInput.value = classData.name;
  classFeeInput.value = classData.fee;
  tuitionFeeInput.value = classData.tuitionFee;
  admissionFeeInput.value = classData.admissionFee
 

  if(isSuperAdmin) document.getElementById('campusDropdown').value = classData.campusId._id

  document.getElementById("addClassModalLabel").innerText = "Update campus";
  formSubmitBtn.innerText = "Update campus";
  modal.show();
}
let selectedcampusId = ''; // Store selected campus
let filteredClasses = originalClassList;

// 👇 Search filter
searchcampusInput.addEventListener('input', () => {
  const searchTerm = searchcampusInput.value.toLowerCase().trim();

  // Apply both filters: campus + search text
  filteredClasses = originalClassList.filter(cls =>
    (selectedcampusId === '' || cls.campusId._id === selectedcampusId) &&
    cls.name.toLowerCase().includes(searchTerm)
  );

  classList = filteredClasses;
  renderTable();
});

// 👇 campus dropdown filter
if (isSuperAdmin) {
  console.log(campusSelectBox1)
  campusSelectBox1.addEventListener('change', (e) => {
    selectedcampusId = e.target.value; // Save selected campus
console.log(selectedcampusId)
    const searchTerm = searchcampusInput.value.toLowerCase().trim();

    // Apply both filters: campus + search text
    filteredClasses = originalClassList.filter(cls =>
      (selectedcampusId === '' || cls.campusId._id === selectedcampusId) &&
      cls.name.toLowerCase().includes(searchTerm)
    );

    classList = filteredClasses;
    renderTable();
  });
}

document.getElementById("addClassModal").addEventListener("hidden.bs.modal", closeModal);


function closeModal() {
  classForm.reset();
  isEditing = false;
  editingId = null;
  formSubmitBtn.textContent = "Add campus";
  document.getElementById("addClassModalLabel").textContent = "Add New campus";
}

//  var teacher

//     document.getElementById('getTeacher').addEventListener('click',async()=>{
//       console.log(teacherIdInput)
//         if(!teacherIdInput.value) return alert('enter teacher id')
//       let schoolId;
//       if (isSuperAdmin) {
//         schoolId = document.getElementById("schoolDropdown").value;
//         if (!schoolId) return alert("Select school first");
//       } else {
//         schoolId = user[0].school._id;
//       }
//       var campus = user[0].campus._id
//       var res = await axios.post('http://202.143.127.181:3001/api/teacher/getById',{id:teacherIdInput.value,schoolId,campus})
//       teacher = res.data
//       teacherName.value = `${teacher.name}  ${teacher.fatherName} `
//       classTeacherId= teacher._id

        
//     })

}

else{
             window.location.href='Dashboard.html'

}





// 
</script>
<script src="index.js"></script>
<script src="dropdown.js"></script>

</body>

</html>