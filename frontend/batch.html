<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Batch Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }

    .minimalist-input {
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: none;
      font-size: 0.95rem;
      padding: 10px;
      transition: all 0.2s ease-in-out;
    }

    .minimalist-input:focus {
      border-color: #000;
      box-shadow: none;
    }

    .modal-content {
      background: #fff;
    }

    .modal-header,
    .modal-footer {
      background: #f9f9f9;
    }

    .btn-dark {
      background-color: #000;
      border: none;
      border-radius: 8px;
    }

    .btn-dark:hover {
      background-color: #333;
    }
  </style>
</head>

<body>

  <div class="container-fluid">
    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column"></nav>
      </div>

           <div class="col  main-content p-0">
        
        <div id="navContent"></div>
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-5 mb-5 border rounded-3">
            <h2 class="mb-4">Add Batch</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addBatchModal">Add New
              Batch</button>

            <h4>All Batches</h4>
            <div class="row">
              <div class="col-3">
                <label for="">Enter Name</label>
                <input type="text" class="form-control" placeholder="Search by Batch Name" id="searchBatch">
              </div>
              <div class="col-3" id="campusSelectBox1"></div>
            </div>

            <div class="table-responsive mt-3" style="max-height: 600px; overflow-y: auto;">
              <table class="table table-bordered table-hover" id="batchTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Batch Name</th>
                    <th>Timings</th>
                    <th>Fee</th>
                    <th>Course Type</th>
                    <th>Course Name</th>
                    <th id="adminth" style="display:none;">Campus</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div class="modal fade" id="addBatchModal" tabindex="-1" aria-labelledby="addBatchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow-sm border-0 rounded-3" style="width:100%; max-width:600px; margin:auto;">
        <form id="batchForm">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-semibold" id="addBatchModalLabel">Add New Batch</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <div id="campusDropdownContainer" class="mb-3"></div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small">Batch Name</label>
                <input type="text" class="form-control minimalist-input" id="batchName" placeholder="Enter batch name"
                  required>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Timings</label>
                <input type="text" class="form-control minimalist-input" id="batchTimings" placeholder="e.g. 9am - 11am"
                  required>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label class="form-label small">Fee</label>
                <input type="number" class="form-control minimalist-input" id="batchFee" placeholder="Enter fee"
                  required>
              </div>
              <div class="col-md-6">
                <label class="form-label small">Course Type</label>
                <select class="form-select minimalist-input" id="courseType" required>
                  <option value="">Select Course Type</option>
                  <option value="computer">Computer</option>
                  <option value="english">English</option>
                </select>
              </div>
              <div class="col-md-6" id="computerCourseContainer" style="display:none;">
                <div class="mb-3">
                  <label for="computerCourse" class="form-label">Computer Course</label>
                  <select id="computerCourse" class="form-select">
                    <option value="">-- Select Computer Course --</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6" id="englishCourseContainer" style="display: none;">
                <div class="mb-3">
                  <label for="englishCourse" class="form-label">English Course</label>
                  <select id="englishCourse" class="form-select">
                    <option value="">-- Select English Course --</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
            <div class="" id="campusSelectBox2"></div>

              </div>
            </div>


          </div>

          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-dark px-4" id="formSubmitBtn">Add Batch</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    const batchNameInput = document.getElementById("batchName");
    const batchTimingsInput = document.getElementById("batchTimings");
    const batchFeeInput = document.getElementById("batchFee");
    const courseTypeInput = document.getElementById("courseType");
    const addButton = document.getElementById("formSubmitBtn");
    const tableBody = document.querySelector("#batchTable tbody");
    const batchForm = document.getElementById("batchForm");
    const adminTh = document.getElementById("adminth");
    const computerCourseSelect = document.getElementById("computerCourse");
    const englishCourseSelect = document.getElementById("englishCourse");
    const user = JSON.parse(localStorage.getItem("userData")) || [];
    const modal = new bootstrap.Modal(document.getElementById("addBatchModal"));

    const toast = new bootstrap.Toast(document.getElementById("toastMessage"));
    const toastBody = document.getElementById("toastBody");
    const toastElement = document.getElementById("toastMessage");

    function showToast(message, isSuccess = true) {
      toastBody.textContent = message;
      toastElement.classList.remove("bg-success", "bg-danger");
      toastElement.classList.add(isSuccess ? "bg-success" : "bg-danger");
      toast.show();
    }

    let isEditing = false;
    let editingId = null;
    const isSuperAdmin = user[0]?.designation === "supremeadmin";

    let batchList = [];
    let originalBatchList = [];

    window.addEventListener("DOMContentLoaded", loadBatches);

    async function loadBatches() {
      console.log(user[0].school._id)
      try {
        let res;
        if (isSuperAdmin) {
          console.log('super')
          res = await axios.get(`http://localhost:3000/api/batch/all/${user[0].school._id}`);
        } else {
          console.log('working')
          res = await axios.get(`http://localhost:3000/api/batch/getByCampus/${user[0].school._id}/${user[0].campus._id}`);
        }
        batchList = res.data.data;
        originalBatchList = [...batchList];
        renderTable();
      } catch (err) {
        console.error("Error loading batches:", err);
      }
    }

    function renderTable() {
      tableBody.innerHTML = "";
      adminTh.style.display = isSuperAdmin ? 'block' : 'none';

      if (batchList.length > 0) {
        batchList.forEach((batch, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${batch.name}</td>
            <td>${batch.timings}</td>
            <td>${batch.fee}</td>
            <td>${batch.courseType}</td>
            <td>${batch.courseName.name}</td>
            ${isSuperAdmin ? `<td>${batch.campusId?.name || 'N/A'}</td>` : ''}
            <td>
              <button class="btn btn-sm btn-info me-1" onclick="editBatch('${batch._id}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteBatch('${batch._id}')">Delete</button>
            </td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No batches found</td></tr>`;
      }
    }

    async function deleteBatch(id) {
      if (!confirm("Are you sure you want to delete this batch?")) return;

      try {
        const res = await axios.delete(`http://localhost:3000/api/batch/delete/${id}`);
        batchList = batchList.filter(b => b._id !== id);
        originalBatchList = originalBatchList.filter(b => b._id !== id);
        showToast(res.data.message || "Deleted successfully");
        renderTable();
      } catch (err) {
        console.error("Failed to delete batch:", err);
        showToast("Failed to delete batch", false);
      }
    }

    // Add / Update Batch
    addButton.addEventListener("click", async (e) => {
      e.preventDefault();

      const name = batchNameInput.value.trim();
      const timings = batchTimingsInput.value.trim();
      const fee = batchFeeInput.value.trim();
      const courseType = courseTypeInput.value.trim();

      if (!name || !timings || !fee || !courseType) {
        alert("Please fill all fields");
        return;
      }
    const createdBy = user[0]._id

      let campusId;
      let schoolId = user[0]?.school?._id;
      if (isSuperAdmin) {
        const dropdown = document.getElementById("campusDropdown");
        campusId = dropdown.value;
        if (!campusId) {
          alert("Please select a campus");
          return;
        }
      } else {
        campusId = user[0].campus._id;
      }
      var selectedCourse = null;
      if(courseType === 'computer'){
         selectedCourse = computerCourseSelect.value;
        if(!selectedCourse){
          alert("Please select a computer course");
          return;
        }
      } else if(courseType === 'english'){
         selectedCourse = englishCourseSelect.value;
        if(!selectedCourse){
          alert("Please select an english course");
          return;
        }
      }
      var courseName = selectedCourse ? (courseType === 'computer' ? computerCourseSelect.options[computerCourseSelect.selectedIndex].value : englishCourseSelect.options[englishCourseSelect.selectedIndex].value) : '';

      try {
        if (isEditing) {
          const res = await axios.put(`http://localhost:3000/api/batch/update/${editingId}`, {
            name, timings, fee, courseType, courseName, campusId, schoolId
          });
          const { data, message } = res.data;
          const index = batchList.findIndex(s => s._id === editingId);
          batchList[index] = data;
          originalBatchList[index] = data;
          showToast(message || "Batch updated successfully");
        } else {
          const res = await axios.post("http://localhost:3000/api/batch/add", {
            name, timings, fee, courseType, courseName, campusId, schoolId , createdBy
          });
          const { data, message } = res.data;
          if (data && data._id) {
            batchList.push(data);
            originalBatchList.push(data);
          }
          showToast(message, data && data._id);
        }

        isEditing = false;
        editingId = null;
        batchForm.reset();
        addButton.textContent = "Add Batch";
        document.getElementById("addBatchModalLabel").textContent = "Add New Batch";
        modal.hide();

        renderTable();
      } catch (err) {
        console.error("Error adding batch:", err);
        alert("Failed to add batch");
      }
    });

    window.deleteBatch = deleteBatch;

    window.editBatch = async function (id) {
      const batchData = batchList.find(b => b._id === id);
      if (!batchData) {
        showToast("Batch not found", false);
        return;
      }

      isEditing = true;
      editingId = id;
      batchNameInput.value = batchData.name;
      batchTimingsInput.value = batchData.timings;
      batchFeeInput.value = batchData.fee;
      courseTypeInput.value = batchData.courseType;
      if (isSuperAdmin) document.getElementById("campusDropdown").value = batchData.campusId._id;
     await handlefillDropDown(batchData.campusId._id)
     await handleDropDownDisplay(batchData.courseType)
      if(batchData.courseType === 'computer'){
        computerCourseSelect.value = batchData.courseName._id
      } else if(batchData.courseType === 'english'){
        englishCourseSelect.value = batchData.courseName._id
      }

      document.getElementById("addBatchModalLabel").innerText = "Update Batch";
      formSubmitBtn.innerText = "Update Batch";
      modal.show();
    }

    document.getElementById("addBatchModal").addEventListener("hidden.bs.modal", () => {
      batchForm.reset();
      isEditing = false;
      editingId = null;
      addButton.textContent = "Add Batch";
      document.getElementById("addBatchModalLabel").textContent = "Add New Batch";
    });
    let filteredBatchList = originalBatchList
    let selectedcampusId = '';


    const searchcampusInput = document.getElementById('searchBatch');
    // ðŸ‘‡ campus dropdown filter
    if (isSuperAdmin) {
      searchcampusInput.addEventListener('input', () => {
        const searchTerm = searchcampusInput.value.toLowerCase().trim();

        // Apply both filters: campus + search text
        filteredBatchList = originalBatchList.filter(cls =>
          (selectedcampusId === '' || cls.campusId._id === selectedcampusId) &&
          cls.name.toLowerCase().includes(searchTerm)
        );

        batchList = filteredBatchList;
        renderTable();
      });

      console.log(campusSelectBox1)
      campusSelectBox1.addEventListener('change', (e) => {
        selectedcampusId = e.target.value; // Save selected campus
        console.log(selectedcampusId)
        const searchTerm = searchcampusInput.value.toLowerCase().trim();

        // Apply both filters: campus + search text
        filteredBatchList = originalBatchList.filter(cls =>
          (selectedcampusId === '' || cls.campusId._id === selectedcampusId) &&
          cls.name.toLowerCase().includes(searchTerm)
        );

        batchList = filteredBatchList;
        renderTable();
      });
    }

    // API endpoints
    const computerCourseApi = `http://localhost:3000/api/course/getbyCampus/${user[0].school._id}/${user[0].campus?._id}`;
    const englishCourseApi = `http://localhost:3000/api/english-courses/getByCampus/${user[0].school._id}/${user[0].campus?._id}`;

    // Function to fill dropdown
    async function fillDropdown(apiUrl, dropdownId) {
      try {
        const res = await axios.get(apiUrl);
        const data = res.data.data; // backend se response
        console.log(data)
        const dropdown = document.getElementById(dropdownId);

        // Clear old options (except default)
        dropdown.innerHTML = '<option value="">-- Select Option --</option>';

        data.forEach(item => {
          const option = document.createElement("option");
          option.value = item._id;       // assuming backend gives _id
          option.textContent = item.name // assuming backend gives name
          dropdown.appendChild(option);
        });

      } catch (error) {
        console.error(`Error loading ${dropdownId}:`, error);
      }
    }

    // Page load pr dropdowns fill karo
    if (!isSuperAdmin) {

      window.onload = () => {
        fillDropdown(computerCourseApi, "computerCourse");
        fillDropdown(englishCourseApi, "englishCourse");
      };
    }

    campusSelectBox2.addEventListener('change', (e) => {
      var selectedCampus = e.target.value
      if (selectedCampus) {
       handlefillDropDown(selectedCampus)
      }
    })
       courseTypeInput.addEventListener('change', (e) => {
      const selectedType = e.target.value;
     handleDropDownDisplay(selectedType)
    });

   async function handlefillDropDown(selectedCampus){
       await fillDropdown(`http://localhost:3000/api/course/getbyCampus/${user[0].school._id}/${selectedCampus}`, "computerCourse");
       await fillDropdown(`http://localhost:3000/api/english-courses/getbyCampus/${user[0].school._id}/${selectedCampus}`, "englishCourse");
    }

   async function handleDropDownDisplay(selectedType){
 if (selectedType === 'computer') {
        document.getElementById('computerCourseContainer').style.display = 'block';
        document.getElementById('englishCourseContainer').style.display = 'none';
      } else if (selectedType === 'english') {
        document.getElementById('computerCourseContainer').style.display = 'none';
        document.getElementById('englishCourseContainer').style.display = 'block';
      } else {
        document.getElementById('computerCourseContainer').style.display = 'none';
        document.getElementById('englishCourseContainer').style.display = 'none';
      }
    }

 

  </script>
  <script src="index.js"></script>
  <script src="dropdown.js"></script>
</body>

</html>