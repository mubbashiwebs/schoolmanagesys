<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Subject Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column"></nav>
      </div>
          <div class="col  main-content p-0">
        
        <div id="navContent"></div>
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-5 mb-5 border rounded-3">
            <h2 class="mb-4">Add Subject</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#subjectModal">Add New Subject</button>

            <h4>All Subjects</h4>
            <div class="row">
              <div class="col-3">
                <label for="searchSubject">Enter Name</label>
                <input type="text" class="form-control minimalist-input" placeholder="Search by Subject Name" id="searchSubject">
              </div>
              <div class="col-3" id="campusSelectBox1"></div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-bordered table-hover" id="subjectTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Subject Name</th>
                    <th id="adminth" style="display: none;">Campus</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="subjectModal" tabindex="-1">
    <div class="modal-dialog  modal-dialog-centered">
      <div class="modal-content">
        <form id="subjectForm">
          <div class="modal-header">
            <h5 class="subjectModalLabel" id="subjectModalLabel">Add New Subject</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Subject Name</label>
              <input type="text" class="form-control minimalist-input" id="subjectName" placeholder="Enter subject name" required>
            </div>
            <div>
              <div id="campusSelectBox2"></div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-dark" id="addSubjectButton">Add Subject</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let isEditing = false;
    let editingId = null;

    const user = JSON.parse(localStorage.getItem("userData")) || [];
    const isSuperAdmin = user[0]?.designation === "supremeadmin";

    function showToast(message, bg = 'bg-success') {
      const toast = document.getElementById("toastMessage");
      const body = document.getElementById("toastBody");
      toast.classList.remove("bg-success", "bg-danger");
      toast.classList.add(bg);
      body.innerText = message;
      new bootstrap.Toast(toast).show();
    }

    if (user.length <= 0) {
      window.location.href = 'Dashboard.html';
    } else {
      let subjectList = [];
      let filteredSubjects = [];

      const subjectTableBody = document.querySelector("#subjectTable tbody");
      const searchInput = document.getElementById("searchSubject");
      const form = document.getElementById("subjectForm");
      const adminTh = document.getElementById('adminth');

      async function loadSubjects() {
        const url = isSuperAdmin 
          ? `http://localhost:3000/api/subject/school/${user[0].school._id}` 
          : `http://localhost:3000/api/subject/getbyCampus/${user[0].school._id}/${user[0].campus._id}`;
        const res = await axios.get(url);
        subjectList = res.data.data;
        filteredSubjects = [...subjectList];
        renderTable();
      }

      function renderTable() {
        subjectTableBody.innerHTML = "";
        adminTh.style.display = isSuperAdmin ? "table-cell" : "none";
        console
        if (filteredSubjects.length === 0) {
          subjectTableBody.innerHTML = `<tr><td colspan="5" class="text-center">No data found</td></tr>`;
          return;
        }

        filteredSubjects.forEach((subject, index) => {
          subjectTableBody.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${subject.name}</td>
              ${isSuperAdmin ? `<td>${subject.campusId?.name || 'N/A'}</td>` : ''}
              <td>
                <button class="btn btn-sm btn-info me-1" onclick="editSubject('${subject._id}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteSubject('${subject._id}')">Delete</button>
              </td>
            </tr>
          `;
        });
      }

      searchInput.addEventListener("input", () => {
        const val = searchInput.value.toLowerCase();
        const selectedCampusId = document.getElementById("campusDropdownfilter")?.value || "";
        filteredSubjects = subjectList.filter(subject =>
          subject.name.toLowerCase().includes(val) &&
          (selectedCampusId === "" || subject.campusId?._id === selectedCampusId)
        );
        renderTable();
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("subjectName").value.trim();
        const campusId = isSuperAdmin ? document.getElementById("campusDropdown").value : user[0].campus._id;
        if (!name || !campusId) return showToast("Please fill all fields", "bg-danger");
        const schoolId = user[0].school._id;
    const createdBy = user[0]._id

        const body = { name, campusId, schoolId ,createdBy };

        try {
          if (isEditing) {
            const res = await axios.put(`http://localhost:3000/api/subject/update/${editingId}`, body);
            const updated = res.data.data;
            if (!updated || !updated._id) return showToast(res.data.message || "Update failed", "bg-danger");
            const idx = subjectList.findIndex(c => c._id === editingId);
            subjectList[idx] = updated;
            filteredSubjects[idx] = updated;
            showToast(res.data.message || "Subject updated successfully");
          } else {
            const res = await axios.post("http://localhost:3000/api/subject/add", body);
            const added = res.data.data;
            if (!added || !added._id) return showToast(res.data.message || "Add failed", "bg-danger");
            subjectList.push(added);
            filteredSubjects = [...subjectList];
            showToast("Subject added successfully");
          }

          isEditing = false;
          editingId = null;
          renderTable();
          form.reset();
          document.getElementById("addSubjectButton").textContent = "Add Subject";
          document.getElementById("subjectModalLabel").textContent = "Add New Subject";
          bootstrap.Modal.getInstance(document.getElementById("subjectModal")).hide();
        } catch (err) {
          console.error(err);
          showToast(err.response?.data?.message || "Server error", "bg-danger");
        }
      });

      window.editSubject = async function (id) {
        const subject = subjectList.find(c => c._id === id);
        if (!subject) return showToast("Subject not found", "bg-danger");
        isEditing = true;
        editingId = id;
        document.getElementById("subjectName").value = subject.name;
        if (isSuperAdmin) {
          document.getElementById("campusDropdown").value = subject.campusId._id;
        }
        document.getElementById("subjectModalLabel").textContent = "Update Subject";
        document.getElementById("addSubjectButton").textContent = "Update Subject";
        const modal = new bootstrap.Modal(document.getElementById("subjectModal"));
        modal.show();
      };

      window.deleteSubject = async (id) => {
        if (!confirm("Are you sure you want to delete this subject?")) return;
        try {
          await axios.delete(`http://localhost:3000/api/subject/delete/${id}`);
          subjectList = subjectList.filter(cls => cls._id !== id);
          filteredSubjects = [...subjectList];
          renderTable();
          showToast("Subject deleted successfully");
        } catch (err) {
          console.error(err);
          showToast("Failed to delete subject", "bg-danger");
        }
      };

      document.getElementById("subjectModal").addEventListener("hidden.bs.modal", closeModal);

      function closeModal() {
        form.reset();
        isEditing = false;
        editingId = null;
        document.getElementById("addSubjectButton").textContent = "Add Subject";
        document.getElementById("subjectModalLabel").textContent = "Add New Subject";
      }

      loadSubjects();
    }
  </script>
  <script src="index.js"></script>
  <script src="dropdown.js"></script>
</body>
</html>
