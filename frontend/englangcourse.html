<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - English Course Form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column"></nav>
      </div>
      <div class="col main-content">
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-5 mb-5 border rounded-3">
            <h2 class="mb-4">Add English Course</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#courseModal">Add New Course</button>

            <h4>All Courses</h4>
            <div class="row">
              <div class="col-3">
                <label for="searchCourse">Enter Name</label>
                <input type="text" class="form-control" placeholder="Search by Level Name" id="searchCourse">
              </div>
              <div class="col-3" id="schoolSelectBox1"></div>
            </div>

            <div class="table-responsive mt-3">
              <table class="table table-bordered table-hover" id="courseTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Level Name</th>
                    <th>Fee</th>
                    <th id="adminth" style="display: none;">School</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="courseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="courseForm">
          <div class="modal-header">
            <h5 class="courseModalLabel" id="courseModalLabel">Add New Course</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Level Name</label>
              <input type="text" class="form-control" id="courseName" placeholder="Enter level name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Fee</label>
              <input type="number" class="form-control" id="courseFee" placeholder="Enter level fee" required>
            </div>
            <div id="schoolSelectBox2"></div>

          </div>
          <div class="modal-footer">
          <button type="submit" id="addCourseButton" class="btn btn-primary">Add Course</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let isEditing = false;
let editingId = null;

    const user = JSON.parse(localStorage.getItem("userData")) || [];
    const isSuperAdmin = user[0]?.designation === "superadmin";
    const sidebar = document.getElementById("sidebar");
    const allLinks = {
      addclass: { name: "Add Class", file: "classform.html" },
      addsection: { name: "Add Section", file: "section.html" },
      addcomputercourse: { name: "Add Computer Course", file: "compcourse.html" },
      addenglangcourse: { name: "Add English lang Course", file: "englangcourse.html", active: true },
      addstudent: { name: "Student Form", file: "student.html" },
      studentlist: { name: "Student List", file: "studentlist.html" },
      addteacher: { name: "Teacher Form", file: "teacher.html" },
      teacherlist: { name: "Teacher List", file: "teacherlist.html" },
      teacherSalary: { name: "Teacher Salary", file: "teacherSalary.html" },
      adduser: { name: "Add User", file: "userform.html" }
    };

    function showToast(message, bg = 'bg-success') {
      const toast = document.getElementById("toastMessage");
      const body = document.getElementById("toastBody");
      toast.classList.remove("bg-success", "bg-danger");
      toast.classList.add(bg);
      body.innerText = message;
      new bootstrap.Toast(toast).show();
    }

    function renderSidebar(user) {
      sidebar.innerHTML = `<a class='active' href="Dashboard.html">Dashboard</a>`;
      if (isSuperAdmin) sidebar.innerHTML += `<a href="schoolform.html">Add School</a>`;
      for (const key in allLinks) {
        const item = allLinks[key];
        const allowed = isSuperAdmin || user[0].allowedPages.includes(key);
        if (allowed) sidebar.innerHTML += `<a href="${item.file}" class="${item.active ? 'active' : ''}">${item.name}</a>`;
        else if (item.active) window.location.href = 'Dashboard.html';
      }
      sidebar.innerHTML += `<a href="#">Logout</a>`;
    }

    if (user.length <= 0) window.location.href = 'Dashboard.html';
    else {
      renderSidebar(user);
      let schoolList = [], courseList = [], filteredCourses = [];
      const schoolSelectBox1 = document.getElementById("schoolSelectBox1");
      const schoolSelectBox2 = document.getElementById("schoolSelectBox2");
      const courseTableBody = document.querySelector("#courseTable tbody");
      const searchInput = document.getElementById("searchCourse");
      const form = document.getElementById("courseForm");

      function renderSchoolDropdown(selectBox, id) {
        const label = document.createElement("label");
    label.textContent = "Select School";
    label.setAttribute("for", "schoolDropdown");
    label.className = "form-label";
        const dropdown = document.createElement("select");
        dropdown.className = "form-select";
        dropdown.id = id;
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select School";
        dropdown.appendChild(defaultOpt);
        schoolList.forEach(school => {
          const opt = document.createElement("option");
          opt.value = school._id;
          opt.textContent = school.name;
          dropdown.appendChild(opt);
        });
        selectBox.innerHTML = "";
        selectBox.appendChild(label);
        selectBox.appendChild(dropdown);
      }

      async function loadSchools() {
        const res = await axios.get("http://localhost:3000/api/school/get");
        schoolList = res.data.data;
        if (isSuperAdmin) {
          renderSchoolDropdown(schoolSelectBox1, "schoolDropdownFilter");
          renderSchoolDropdown(schoolSelectBox2, "schoolDropdownForm");
          document.getElementById("adminth").style.display = "table-cell";
        }
      }

      async function loadCourses() {
        const url = isSuperAdmin ? "http://localhost:3000/api/english-courses/all" : `http://localhost:3000/api/english-courses/school/${user[0].school._id}`;
        const res = await axios.get(url);
        courseList = res.data.data;
        filteredCourses = [...courseList];
        console.log(courseList)
        renderTable();
      }

      function renderTable() {
        courseTableBody.innerHTML = "";
        if (filteredCourses.length === 0) {
          courseTableBody.innerHTML = `<tr><td colspan="5" class="text-center">No data found</td></tr>`;
          return;
        }

        filteredCourses.forEach((course, index) => {
          courseTableBody.innerHTML += `
            <tr>
              <td>${index + 1}</td>
              <td>${course.levelName}</td>
              <td>${course.fee}</td>
              <td style="display: ${isSuperAdmin ? 'table-cell' : 'none'}">${course.schoolId?.name || ''}</td>
              <td>
        <button class="btn btn-sm btn-info me-1" onclick="editCourse('${course._id}')">Edit</button>

                <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course._id}')">Delete</button>
                </td>
            </tr>
          `;
        });
      }

      searchInput.addEventListener("input", () => {
        const val = searchInput.value.toLowerCase();
        const selectedSchoolId = document.getElementById("schoolDropdownFilter")?.value || "";
        filteredCourses = courseList.filter(course =>
          course.levelName.toLowerCase().includes(val) &&
          (selectedSchoolId === "" || course.schoolId?._id === selectedSchoolId)
        );
        renderTable();
      });

      schoolSelectBox1.addEventListener("change", () => {
        searchInput.dispatchEvent(new Event("input"));
      });

      form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const levelName = document.getElementById("courseName").value.trim();
  const fee = document.getElementById("courseFee").value.trim();
  const schoolId = isSuperAdmin ? document.getElementById("schoolDropdownForm").value : user[0].school._id;

  if (!levelName || !fee || !schoolId) return showToast("Please fill all fields", "bg-danger");

  const body = { levelName, fee, schoolId };

  try {
    if (isEditing) {
      // ðŸ”„ UPDATE
      const res = await axios.put(`http://localhost:3000/api/english-courses/update/${editingId}`, body);
      const updated = res.data.data;

      if (!updated || !updated._id) return showToast(res.data.message || "Update failed", "bg-danger");

      const idx = courseList.findIndex(c => c._id === editingId);
      courseList[idx] = updated;
      filteredCourses[idx] = updated;

      showToast(res.data.message || "Course updated successfully");
    } else {
      // âž• ADD
      const res = await axios.post("http://localhost:3000/api/english-courses/add", body);
      const added = res.data.data;

      if (!added || !added._id) return showToast(res.data.message || "Add failed", "bg-danger");

      courseList.push(added);
      filteredCourses = [...courseList];
      showToast("Course added successfully");
    }

    isEditing = false;
    editingId = null;
    form.reset();
    renderTable();
    bootstrap.Modal.getInstance(document.getElementById("courseModal")).hide();

    // Reset button and label
    document.getElementById("addCourseButton").textContent = "Add Course";
    document.getElementById("courseModalLabel").textContent = "Add New Course";
  } catch (err) {
    console.error(err);
    showToast(err.response?.data?.message || "Server error", "bg-danger");
  }
});

window.editCourse = function (id) {
  const course = courseList.find(c => c._id === id);
  if (!course) return showToast("Course not found", "bg-danger");

  isEditing = true;
  editingId = id;

  document.getElementById("courseName").value = course.levelName;
  document.getElementById("courseFee").value = course.fee;
  if (isSuperAdmin) {
    document.getElementById("schoolDropdownForm").value = course.schoolId._id;
  }

  document.getElementById("courseModalLabel").textContent = "Update Course";
  document.getElementById("addCourseButton").textContent = "Update Course";
  const modal = new bootstrap.Modal(document.getElementById("courseModal"));
  modal.show();
};


      window.deleteCourse = async (id) => {
        if (!confirm("Are you sure you want to delete this course?")) return;
        try {
          await axios.delete(`http://localhost:3000/api/english-courses/delete/${id}`);
          courseList = courseList.filter(cls => cls._id !== id);
          filteredCourses = [...courseList];
          renderTable();
          showToast("Course deleted successfully");
        } catch (err) {
          console.error(err);
          showToast("Failed to delete course", "bg-danger");
        }
      };
document.getElementById("courseModal").addEventListener("hidden.bs.modal", closeModal);

      function closeModal() {
  form.reset();
  isEditing = false;
  editingId = null;
  document.getElementById("addCourseButton").textContent = "Add School";
  document.getElementById("courseModalLabel").textContent = "Add New School";
}

      loadSchools();
      loadCourses();
    }
  </script>
</body>
</html>
