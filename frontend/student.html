  <!DOCTYPE html>
  <html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Student Form</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="index.css" />
     <style>
    body {
      background: #f7f9fc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .form-section {
      background: #fff;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    h2, h5 {
      font-weight: 600;
    }

    label {
      font-weight: 500;
      font-size: 0.9rem;
    }

    input, select, textarea {
      border-radius: 10px !important;
    }

    .btn-primary {
      border-radius: 12px;
      padding: 0.6rem 1.4rem;
      font-weight: 500;
    }

    .upload-box {
      border: 2px dashed #ced4da;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-box:hover {
      border-color: #0d6efd;
      background: #f0f7ff;
    }

    .student-img {
      border-radius: 12px;
      border: 1px solid #eee;
    }
       input[type='text'] ,  input[type='date'] , input[type='email'] , select , textarea    {
      padding: 10px 14px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 18px;
      font-size: 14px;
      transition: border-color 0.3s;
      background-color: #fdfdfd;
    }


    input:focus {
      border-color: #5c6ac4;
      outline: none;
    }
       /* Loader styles */
.loader-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.8);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Spinner animation */
.spinner {
  width: 50px;
  height: 50px;
  border: 6px solid #ccc;
  border-top-color: #3498db;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
  </style>
  </head>

  <body>
    <!-- Spinner HTML -->
<div id="loader" class="loader-overlay">
  <div class="spinner"></div>
</div>
    <div class="container-fluid">
      <div class="row flex-nowrap">
        <!-- Sidebar -->
        <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 d-md-block d-none sidebar sticky-top">
          <h4>Admin Panel</h4>
          <nav id="sidebar" class="nav flex-column">
        
          </nav>
        </div>

        <!-- Main Content -->
              <div class="col  main-content p-0">
        
        <div id="navContent"></div>
          <div class="row main-content-area d-flex justify-content-center align-items-start min-vh-100 py-4">
            <div class="col-10  rounded-3">
             <div class="container py-5">
    <h2 class="text-center mb-5">ðŸŽ“ Student Admission Form</h2>

    <!-- Image Upload -->
    <div class="form-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <label class="fw-bold mb-2">Upload Student Image</label>
          <div class="upload-box">
            <input type="file"   id="studentImage" accept="image/*">
            <button class="btn btn-dark mt-3" id="uploadImage">Upload</button>
          </div>
        </div>
        <div class="col-md-6 text-center">
          <img src="" id="studentImageBox" class="student-img img-fluid" width="120" alt="Student Image">
        </div>
      </div>
    </div>

    <!-- Personal Info -->
    <form id="admissionForm">
      <div class="form-section">
        <h5 class="mb-4">Personal Information</h5>
        
        <div class="row g-3">
          <div class="col-md-6">
            <label>Name</label>
            <input type="text" name="name"   required>
          </div>
          <div class="col-md-6">
            <label>Father Name</label>
            <input type="text" name="fatherName"   required>
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label>Date of Birth</label>
            <input type="date" name="dob"   required>
          </div>
          <div class="col-md-6">
            <label>CNIC/B-Form</label>
            <input type="text" name="cnic"   required>
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label>Email</label>
            <input type="email" name="email"  >
          </div>
          <div class="col-md-6">
            <label>Phone</label>
            <input type="text" name="phone"  >
          </div>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label>Gender</label>
            <select name="gender">
              <option value="">Select</option>
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
          <div class="col-md-6">
            <label>Address</label>
            <textarea name="address" rows="1"  ></textarea>
          </div>
        </div>
      </div>

      <!-- Qualification Info -->
      <div class="form-section">
        <h5 class="mb-4">Qualification Information</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label>Last Qualification</label>
            <input type="text" name="lastQualification"  >
          </div>
          <div class="col-md-6">
            <label>Last School</label>
            <input type="text" name="lastSchool"  >
          </div>
        </div>
        <div class="mt-3">
          <label>Admission Date</label>
          <input type="date" name="admissionDate"  >
        </div>
        <div class="mt-3">
          <label class="fw-bold">Select Admission Type</label><br>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="admissionType" value="school">
            <label class="form-check-label">School</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="admissionType" value="tuition">
            <label class="form-check-label">Tuition</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="admissionType" value="computer">
            <label class="form-check-label">Computer Class</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" name="admissionType" value="english">
            <label class="form-check-label">English Language</label>
          </div>
        </div>
        <div class="row g-3 mt-3" id="classSectionFields" style="display: none;">
          <div class="col-md-6">
            <label>Admission Class</label>
            <select name="class" id="admissionClass" class="form-select"></select>
          </div>
          <div class="col-md-6">
            <label>Admission Section</label>
            <select name="section" id="admissionSection" class="form-select"></select>
          </div>
        </div>
           <!-- <div class="row g-3 mt-3" id="tuitionFields" style="display: none;">
          <div class="col-md-6">
            <label>Tuition Class</label>
            <select name="tuitionClass" id="tuitionClass" class="form-select"></select>
          </div> -->
         
        </div>
        <div class="mt-3" id="computerCourseField" style="display: none;">
          <label>Computer Course</label>
          <select name="computerCourse" id="computerCourse" class="form-select"></select>
           <br>
                      <label for="">Batch</label>
                          <select name="computerCourseBatch" id="computerCourseBatch" class="form-select">

                  </select>
        </div>
        <div class="mt-3" id="engCourseField" style="display: none;">
          <label>English Course</label>
          <select name="englishCourse" id="englishCourse" class="form-select"></select>
            <br>
                      <label for="">Batch</label>
                            <select name="engCourseBatch" id="engCourseBatch" class="form-select">
                  </select>
        </div>
      </div>

      <!-- Status -->
      <div class="form-section">
        <h5 class="mb-3">Status</h5>
        <div>
          <input type="radio" name="status" id="available" value="active" checked>
          <label for="available" class="me-3">Active</label>
          <input type="radio" name="status" id="left" value="left">
          <label for="left">Left</label>
        </div>
        <div class="mt-3" id="leaveReasonBox" style="display: none;">
          <label>Leave Reason</label>
          <input type="text" name="leftReason"   id="leaveReason" placeholder="Enter reason for leaving">
        </div>
      </div>

      <!-- Fee Info -->
      <div class="form-section">
        <h5 class="mb-3">Fee Info</h5>
        <label class="fw-bold">Total Amount:</label>
        <input type="number" class="form-control mt-2" disabled id="totalFee" name="totalFee">
        <div>
          <div id="Fee-info">
        </div>
      </div>

      <div class="text-center">
        <button type="submit" class="btn btn-primary px-5">Submit</button>
      </div>
    </form>
  </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- JS Logic -->
    <script>
       const statusRadios = document.querySelectorAll('input[name="status"]');
  const leaveReasonBox = document.getElementById('leaveReasonBox');
  const leaveReasonInput = document.getElementById('leaveReason');
  // Show/hide Leave Reason box
  statusRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      leaveReasonBox.style.display = document.getElementById('left').checked ? 'block' : 'none';
    });
  });
  const user = JSON.parse(localStorage.getItem("userData")) || [];
  const isSuperAdmin = user[0]?.designation === "supremeadmin";
  const fileInput = document.getElementById("studentImage");
  const imageBox = document.getElementById("studentImageBox");
  var campusId = user[0]?.campus?._id || null;
  var engCourseBatchSelect = document.getElementById('engCourseBatch')
  var computerCourseBatchSelect = document.getElementById('computerCourseBatch')
    //  const sidebar = document.getElementById("sidebar");
var editingStudentId 
// const allLinks = {
//   // dashboard: { name: "Dashboard", file: "Dashboard.html" },
//   addclass: { name: "Add Class", file: "classform.html", active:false },
//   addsection: { name: "Add Section", file: "section.html", active:false },
//   addschool: { name: "Add School", file: "schoolform.html", active:false },
//   addcomputercourse: { name: "Add Computer Course", file: "compcourse.html", active:false },
//   addstudent: { name: "Student Form", file: "student.html", active:true },
//   studentlist: { name: "Student List", file: "studentlist.html" , active:false},
//   feeReceipt: { name: "Fee Receipt", file: "feeReceipt.html" , active:false},
//   addteacher: { name: "Teacher Form", file: "teacher.html",  active:false },
//   teacherlist: { name: "Teacher List", file: "teacherlist.html" , active:false},
//   teacherSalary: { name: "Teacher Salary", file: "teacherSalary.html" , active:false},

//   adduser: { name: "Add User", file: "userform.html" , active:false}

// };
 if(user.length <= 0){
     window.location.href= 'Dashboard.html'
        
  }

// function renderSidebar(user) {
//   // console.log(user[0].allowPages)
//   // Always show Dashboard and Logout
//   sidebar.innerHTML = `<a class='' href="Dashboard.html">Dashboard</a>`;
//    if(isSuperAdmin){
//   sidebar.innerHTML += `<a href="schoolform.html">Add School</a>`;

//   }

//   for (const key in allLinks) {
//     console.log(key)
//     if(isSuperAdmin){
//       sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;

//     }
    
//    else {
//    if (user[0].allowedPages.includes(key)) {
//       sidebar.innerHTML += `<a href="${allLinks[key].file}" class="${allLinks[key].active?'active':''}">${allLinks[key].name}</a>`;
//     }
//      else{
//         if(allLinks[key].active){
//             window.location.href='Dashboard.html'
//         }
//       }
//     }
//   }

//   sidebar.innerHTML += `<a href="#">Logout</a>`;
// }

// renderSidebar(user)
 
// var tuitionclass = document.getElementById('tuitionClass')
    const form = document.getElementById("admissionForm");
  var isEdit = false

      var imageUrl
      const checkboxes = document.querySelectorAll('input[name="admissionType"]');
      const classSectionFields = document.getElementById('classSectionFields');
      const computerCourseField = document.getElementById('computerCourseField');
      const englishCourseField = document.getElementById('engCourseField');
      // const tuitionFields = document.getElementById('tuitionFields');
      
      const admissionClassSelect = document.getElementById("admissionClass");
      const admissionSectionSelect = document.getElementById("admissionSection");
      const computerCourse = document.getElementById('computerCourse')
      function updateFormDisplay() {
        const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        classSectionFields.style.display = selected.includes('school') ? 'flex' : 'none';
        computerCourseField.style.display = selected.includes('computer') ? 'block' : 'none';
        engCourseField.style.display = selected.includes('english') ? 'block' : 'none'
        // tuitionFields.style.display = selected.includes('tuition') ? 'flex' : 'none';
        updateFee()
      }

      checkboxes.forEach(cb => cb.addEventListener('change', updateFormDisplay));

      document.getElementById('admissionForm').addEventListener('submit', async function (e) {
        e.preventDefault();
         
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
           if(imageUrl){
          data.imageUrl = imageUrl
        }
        else{
          // alert('select image')
          showToast("error", 'select image')
          // console.log('not')
          return
        }
        data.admissionTypes = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        data.class = admissionClassSelect.options[admissionClassSelect.selectedIndex]?.value || "";
data.section= admissionSectionSelect.options[admissionSectionSelect.selectedIndex]?.value || "";
data.computerCourse= computerCourse.options[computerCourse.selectedIndex]?.value || "";
data.englishCourse = engcourseSelect.options[engcourseSelect.selectedIndex].value || ''
        if (!data.admissionTypes.includes('school') ) {
           data.class = null
           data.section = null
        }
        if(!data.admissionTypes.includes('tuition')){
           data.section = null
          
        }
        if (!data.admissionTypes.includes('computer')) {
           data.computerCourse = null
           data.computerCourseBatch = null
        }

           if (!data.admissionTypes.includes('english')) {
           data.englishCourse = null
           data.engCourseBatch = null
        }
         // Add schoolId to request body
    data.schoolId = schoolId;

        const selectedStatus = document.querySelector('input[name="status"]:checked').value;
    const leaveReason = leaveReasonInput.value;

        if(selectedStatus == 'left'){ 
          data.status = selectedStatus
          data.leftReason = leaveReason

        }
        else{
          data.status = selectedStatus
           data.leftReason = ''

        }

        // data.grno = studentList.length + 1

      // âž• Add Fee Details
  const feeTypes = ["school", "tuition", "computer", "english"];
  const feeDetails = {};

  feeTypes.forEach((type) => {
    const original = document.getElementById(`${type}Original`);
    const discount = document.getElementById(`${type}Discount`);
    const payable = document.getElementById(`${type}Payable`);

    if (original && discount && payable) {
      feeDetails[type] = {
        originalFee: Number(original.innerText),
        discount: Number(discount.value) || 0,
        payableFee: Number(payable.innerText),
      };
    }
  });

  const totalFee = document.getElementById("totalFee")?.value || 0;
      const submitBtn = document.querySelector('button[type="submit"]');
        console.log(submitBtn)

  data.feeDetails = feeDetails;
  data.totalFee = Number(totalFee);
    const createdBy = user[0]._id

  data.createdBy = createdBy
try{
   if (isEdit) {
    showLoader()
          submitBtn.textContent = 'updating...'

        // UPDATE STUDENT
        const res = await axios.put(
          `http://localhost:3000/api/student/update/${editingStudentId}`,
          data
        );
        // alert(res.data.message || "Student updated successfully");
          showToast("success", res.data.message || "Student updated successfully")
        
        editingStudentId = null;
        submitBtn.textContent = 'submit'
        hideLoader()
      } else {
        // ADD STUDENT
        submitBtn.textContent = 'submiting...'

        const res = await axios.post(
          "http://localhost:3000/api/student/add",
          data
        );
        // alert(res.data.message || "Student added successfully");
          showToast("success", res.data.message )
        
          submitBtn.textContent = 'submit'
        
      }
      form.reset();
      feeInfo.innerHTML = ''
      imageBox.src = ''
      imageUrl = ''
      fileInput.value = ''
      hideLoader()
      // feeInput.value = "";
    } catch (err) {
      console.log(err)
      console.error("Failed to add student:", err);
      // alert("Failed to add student. Please check the form and try again.");
          showToast("error", "Failed to add student. Please check the form and try again.")
          hideLoader()

    }
        console.log('Submitted Data:', data);
        // TODO: Send to backend using fetch or axios
      });
    
        const queryParams = new URLSearchParams(window.location.search);
    const isViewMode = queryParams.get("view") === "true";
  var studentData 


async function loadData() {
  studentData = JSON.parse(localStorage.getItem("viewStudentData"));
  console.log(studentData);

  editingStudentId = studentData?._id;
  console.log(editingStudentId);
  if (!isViewMode || !studentData) return;
 
   if(studentData.status == 'left'){
    leaveReasonBox.style.display = 'block'
   }
  // Set image if exists
  if (studentData.imageUrl) {
    imageBox.src = studentData.imageUrl;
    imageUrl = studentData.imageUrl;
  }

  // Set schoolId and load dependent dropdowns
  if (studentData.schoolId) {
    console.log(studentData.campusId)
  
    if(isSuperAdmin){
    schoolId = studentData.schoolId._id;
      console.log(campusDropdown)

      console.log(campusDropdown.value)
    campusId = studentData.campusId._id;
    console.log(campusDropdown.value)
    

    }
    schoolId = studentData.schoolId._id;
    campusId = studentData.campusId._id;
    console.log(campusId)

    await Promise.all([
      loadClasses(),
      loadSections(),
      loadCourses(),
      loadEngCourses(),
      loadComputerBatches(),
      loadEnglishBatches(),
      
    ]);
  }


  // Fill basic fields (excluding special ones)
  for (let key in studentData) {
    if (["imageUrl", "schoolId", "admissionTypes"].includes(key)) continue;

    const el = form.elements[key];
    if (!el) continue;

    if (key === "dob" || key === "admissionDate") {
      el.value = studentData[key]?.slice(0, 10);
    } else if (el.type === "select-one") {
      el.value = studentData[key] || "";
    } else {
      el.value = studentData[key];
    }
  }

  // âœ… Set dropdown selections from loaded options
var schoolId = user[0].school._id;
  if (studentData.class) {
    console.log(allClasses)
    const selected = allClasses.find(c => c._id == studentData.class._id);
    console.log(studentData.class, selected)
    if (selected) classSelect.value = selected._id;
  }
  if(isSuperAdmin){
     if (studentData.campusId) {
    campusDropdown.value = studentData.campusId._id;
  }
  }
 

  if (studentData.section) {
    sectionSelect.value = studentData.section._id;
  }

  if (studentData.computerCourse) {
    const selected = allCourses.find(c => c._id === studentData.computerCourse._id);
    console.log(selected)
    if (selected) courseSelect.value = selected._id;
  }

  if (studentData.englishCourse) {
    const selected = engCourses.find(c => c._id === studentData.englishCourse._id);
    if (selected) engcourseSelect.value = selected._id;
  }

 await updateComputerCourseBatches()
    await  updateEnglishCourseBatches()
 
  if (studentData.engCourseBatch) {
    console.log(studentData.engCourseBatch)
    console.log(engCourseBatchSelect)
    engCourseBatchSelect.value = studentData.engCourseBatch._id;
    console.log(engCourseBatchSelect.value)
  }
    if (studentData.computerCourseBatch) {
    computerCourseBatchSelect.value = studentData.computerCourseBatch._id;
  }
  // Check admissionTypes checkboxes
  if (Array.isArray(studentData.admissionTypes)) {
    document.querySelectorAll('input[name="admissionType"]').forEach(cb => {
      cb.checked = studentData.admissionTypes.includes(cb.value);
    });
  }

  // Disable fee discount input fields
  setTimeout(() => {
    updateFormDisplay()
    const feeTypes = ["school", "tuition", "computer", "english"];
    feeTypes.forEach(type => {
      const discount = document.getElementById(`${type}Discount`);
      if (discount) discount.disabled = true;
    });
  }, 150);

  // Disable entire form initially
  imageUrl = studentData.imageUrl || "";
  document.getElementById('studentImage').disabled = true;
  document.getElementById('uploadImage').disabled = true;
  Array.from(form.elements).forEach(el => el.disabled = true);
  const submitBtn = document.querySelector('button[type="submit"]');
  submitBtn.outerHTML = `<button type="button" id="editBtn" class="btn btn-warning mt-3">Edit</button>`;

  // Enable form on edit
  document.getElementById("editBtn").addEventListener("click", () => {
    Array.from(form.elements).forEach(el => el.disabled = false);
    document.getElementById("editBtn").style.display = "none";
    isEdit = true;
    document.getElementById('studentImage').disabled = false;
    document.getElementById('uploadImage').disabled = false;

    const submitBtn = document.createElement("button");
    submitBtn.className = "btn btn-primary mt-3";
    submitBtn.type = "submit";
    submitBtn.id = 'submitbtn'
    submitBtn.textContent = "Update";
    form.appendChild(submitBtn);
  });
}


  


  var schoolId = user[0].school._id;
  var feeInfo = document.getElementById('Fee-info')
  // Form elements
  const classSelect = document.getElementById("admissionClass");
  const sectionSelect = document.getElementById("admissionSection");
  const courseSelect = document.getElementById("computerCourse");
  const engCourseField = document.getElementById("engCourseField");
  const engcourseSelect = document.getElementById("englishCourse");
  const feeInput = document.getElementById("admissionFee");
  // const form = document.getElementById("studentForm");

  let allClasses = [];
  let allSections = [];
  let allCourses = [];
  let engCourses = [];
   let schoolList = [];
var schoolDropdown
  // ðŸ”½ Inject dropdown if superadmin
 
    // ðŸŸ¢ Fetch and populate schools dropdown
    let campusList = [];

  // ðŸ”½ Inject dropdown if superadmin
  
    // ðŸŸ¢ Fetch and populate schools dropdown
    async function loadCampuses() {
      if (isSuperAdmin) {
    const campusDropdown = document.createElement("select");
    campusDropdown.className = "form-select mb-3";
    campusDropdown.id = "campusDropdown";
    campusDropdown.name = "campusId";
    campusDropdown.required = true;
    campusDropdown.addEventListener('change', async(e)=>{
      campusId = e.target.value
      loadClasses()
      loadCourses()
      loadEngCourses()
      loadSections()
      loadComputerBatches()
      loadEnglishBatches()
      // loadData()

    })
    const label = document.createElement("label");
    label.textContent = "Select Campus";
    label.setAttribute("for", "campusDropdown");
    label.className = "form-label";

    // const form = document.getElementById("classForm");
    form.insertBefore(label, form.children[2]); // Insert before fee input
    form.insertBefore(campusDropdown, form.children[3]);
  
      try {        const res = await axios.get(`http://localhost:3000/api/campus/getBySchool/${user[0].school._id}`);

        campusList = res.data;
      campusDropdown.innerHTML = `<option value="">Select Campus</option>`;

        campusList.forEach(campus => {
          const option = document.createElement("option");
          option.value = campus._id;
          option.textContent = campus.name;
          campusDropdown.appendChild(option);
        });
      } catch (err) {
        console.error("Error fetching schools:", err);
      }
    }
    }
    
  

  // Load data on page load
  window.addEventListener("DOMContentLoaded", async () => {

    
    await Promise.all([
      
    loadCampuses(),
      loadClasses(),
      loadSections(),
      loadCourses(),
      loadEngCourses(),
      loadComputerBatches(),
      loadEnglishBatches()
    ]);
    
    loadData()

  });

 async function loadEngCourses() {
      
      if (!campusId) return;

    try {
      const url =`http://localhost:3000/api/english-courses/getByCampus/${user[0].school._id}/${campusId}`;
      const res = await axios.get(url);
      engCourses = res.data.data;
      console.log(engCourses)
      engcourseSelect.innerHTML = `<option value="">Select Course</option>`;
      engCourses.forEach(course => {
        const option = document.createElement("option");
        option.value = course._id;
        option.textContent = course.name;

        engcourseSelect.appendChild(option);
      });
    } catch (err) {
      console.error("Error loading computer courses:", err);
    }
  }

  


    // Load Classes
    async function loadClasses() {  
        console.log(campusId)
      if (!campusId) return;
     

      try {
        const url =  `http://localhost:3000/api/class/getByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allClasses = res.data.data;
        classSelect.innerHTML = `<option value="">Select Class</option>`;
        // tuitionclass.innerHTML = `<option value="">Select Class</option>`;

        allClasses.forEach(cls => {
          const option = document.createElement("option");
          option.value = cls._id;
          option.textContent = cls.name;
          option.setAttribute("data-id", cls._id); // store ID in data attribute

          classSelect.appendChild(option);
        });
          //    allClasses.forEach(cls => {
          // const option = document.createElement("option");
          // option.value = cls._id;
          // option.textContent = cls.name;
          // option.setAttribute("data-id", cls._id); // store ID in data attribute

          // tuitionclass.appendChild(option);
        // });
      } catch (err) {
        console.error("Error loading classes:", err);
      }
    }

    // Load Sections (independent of class)
    async function loadSections() {
      if (!campusId) return;
    
      try {
        const url =  `http://localhost:3000/api/section/getByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allSections = res.data.data;
        sectionSelect.innerHTML = `<option value="">Select Section</option>`;
        allSections.forEach(sec => {
          const option = document.createElement("option");
          option.value = sec._id;
          option.textContent = sec.name;
          sectionSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading sections:", err);
      }
    }

    // Load Computer Courses
    async function loadCourses() {
      if (!campusId) return;
     
      try {
        const url = `http://localhost:3000/api/course/getbyCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allCourses = res.data.data;
        courseSelect.innerHTML = `<option value="">Select Course</option>`;
        allCourses.forEach(course => {
          const option = document.createElement("option");
          option.value = course._id;
          option.textContent = course.name;
          option.setAttribute("data-id", course._id); // store ID in data attribute

          courseSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }

    

// Function to handle computer course batch population
function updateComputerCourseBatches() {
  const selectedCourseId = courseSelect.value;
  const selectedCourse = allCourses.find(c => c._id === selectedCourseId);

  if (selectedCourse) {
    const batches = allComputerBatches.filter(
      b => b.courseName.name === selectedCourse.name
    ) || [];

    computerCourseBatchSelect.innerHTML = `<option value="">Select Batch</option>`;

    batches.forEach(batch => {
      const option = document.createElement("option");
      option.value = batch._id;
      option.textContent = batch.name;
      computerCourseBatchSelect.appendChild(option);
    });
  } else {
    computerCourseBatchSelect.innerHTML = `<option value="">Select Batch</option>`;
  }
}

// Function to handle English course batch population
function updateEnglishCourseBatches() {
  const selectedCourseId = engcourseSelect.value;
  const selectedCourse = engCourses.find(c => c._id === selectedCourseId);

  if (selectedCourse) {
    const batches = allEnglishBatches.filter(
      b => b.courseName.name === selectedCourse.name
    ) || [];

    engCourseBatchSelect.innerHTML = `<option value="">Select Batch</option>`;

    batches.forEach(batch => {
      const option = document.createElement("option");
      option.value = batch._id;
      option.textContent = batch.name;
      engCourseBatchSelect.appendChild(option);
    });
  } else {
    engCourseBatchSelect.innerHTML = `<option value="">Select Batch</option>`;
  }
}

// Event listeners
courseSelect.addEventListener('change', updateComputerCourseBatches);
engcourseSelect.addEventListener('change', updateEnglishCourseBatches);
 function updateFee() {

  if (!courseSelect || courseSelect.selectedIndex === -1 || !classSelect || classSelect.selectedIndex === -1 ) {
    console.warn("Class or course not selected properly.");
    return;
  }

  const selectedCourseOption = courseSelect.options[courseSelect.selectedIndex];
  const selectedCourseId = selectedCourseOption?.value;
  const selectedCourse = allCourses.find(course => course._id === selectedCourseId);

  const selectedClassOption = classSelect.options[classSelect.selectedIndex];
  const selectedClassId = selectedClassOption?.value;
  const selectedClass = allClasses.find(cls => cls._id === selectedClassId);

  const selectedEngCourseOption = engcourseSelect.options[engcourseSelect.selectedIndex];
  const selectedEngCourseId = selectedEngCourseOption?.value;
  const selectedEngCourse = engCourses.find(course => course._id === selectedEngCourseId);
  // ... rest of your code



  const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
  feeInfo.innerHTML = ''; // Clear old content

  let totalFee = 0;

  const createFeeSection = (label, feeAmount, discount, key) => {
    console.log(discount.discount)
    const sectionId = `${key}FeeSection`;
    const discountId = `${key}Discount`;
    const payableId = `${key}Payable`;

    feeInfo.innerHTML += `
      <div class="row my-2" id="${sectionId}">
        <div class="col d-flex">
          <label class="fw-bold me-2">${label} Fee:</label>
          <p class="mb-0" id="${key}Original">${feeAmount}</p>
        </div>
        <div class="col-4">
          <label class="fw-bold">Discount:</label>
          <input type="number" min="0" value="${discount.discount}"   id="${discountId}" />
        </div>
        <div class="col d-flex">
          <label class="fw-bold me-2">Payable:</label>
          <p class="mb-0" id="${payableId}">${feeAmount-discount.discount}</p>
        </div>
      </div>
    `;

    // Attach event listener to update payable fee on discount input
    setTimeout(() => {
      const discountInput = document.getElementById(discountId);
      const payableField = document.getElementById(payableId);
      discountInput.addEventListener('input', () => {
        const discount = parseFloat(discountInput.value) || 0;
        const payable = Math.max(0, feeAmount - discount);
        payableField.innerText = payable;
        calculateTotalFee(); // update total on any discount change
      });
    }, 100);
  };

  if (selected.includes('school') && selectedClass) {
    createFeeSection('School', Number(selectedClass.fee), { discount: studentData?.feeDetails?.school?.discount || 0 }, 'school');
    totalFee += Number(selectedClass.fee);
  }

  if (selected.includes('tuition') && selectedClass) {
    createFeeSection('Tuition', Number(selectedClass.tuitionFee), { discount: studentData?.feeDetails?.tuition?.discount || 0 }, 'tuition');
    totalFee += Number(selectedClass.tuitionFee);
  }

  if (selected.includes('computer') && selectedCourse) {
        var batches = allComputerBatches.filter(b => b.courseName.name === selectedCourse.name) || []
    var batch = batches.find(b => b._id === computerCourseBatchSelect.value) || {}
    createFeeSection('Computer', Number(batch.fee), { discount: studentData?.feeDetails?.computer?.discount || 0 }, 'computer');
    totalFee += Number(batch.fee);
  }

  if (selected.includes('english') && selectedEngCourse) {
    console.log(selectedEngCourse.name)
        var batches = allEnglishBatches.filter(b => b.courseName.name === selectedEngCourse.name) || []
        console.log(allEnglishBatches)
    var batch = batches.find(b => b._id === engCourseBatchSelect.value) || {}
    console.log(batch)
    createFeeSection('English', Number(batch.fee),  { discount: studentData?.feeDetails?.english?.discount || 0 }, 'english');
    totalFee += Number(batch.fee);
  }

  setTimeout(() => calculateTotalFee(), 100); // calculate total at the end
}

function calculateTotalFee() {
  const feeTypes = ['school', 'tuition', 'computer', 'english'];
  let total = 0;
  feeTypes.forEach(key => {
    const payable = document.getElementById(`${key}Payable`);
    if (payable) {
      total += parseFloat(payable.innerText) || 0;
    }
  });

  // Show total somewhere, or set to a hidden input
  const totalFeeInput = document.getElementById('totalFee');
  console.log(totalFeeInput)
  if (totalFeeInput) totalFeeInput.value = total;
}


  // Show fee based on selected class
  classSelect.addEventListener("change", () => {
    console.log(123)
 updateFee()
  });

  // Show fee based on selected course (optional override)
  courseSelect.addEventListener("change", () => {

 updateFee()
    
  });

    engcourseSelect.addEventListener("change", () => {

 updateFee()
    
  });
  engCourseBatchSelect.addEventListener("change", () => {

 updateFee()
  });
  computerCourseBatchSelect.addEventListener("change", () => {
  updateFee()
    });

  document.getElementById('uploadImage').addEventListener('click', async () => {

  if (fileInput.files.length > 0) {
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("upload_preset", "student_unsigned");  // your unsigned upload preset

    try {
      const res = await axios.post(
        "https://api.cloudinary.com/v1_1/drtd00x70/image/upload",
        formData,  // <-- send formData directly here
        {
          headers: {
            "Content-Type": "multipart/form-data",
          },
        }
      );
      const data = res.data;
       imageUrl = data.secure_url;
      imageBox.src = imageUrl
      // console.log("Uploaded Image URL:", imageUrl);
        showToast('success', "Image uploaded successfully");

    } catch (error) {
      // console.error("Upload error:", error.response.data);
        showToast('error', "Upload error");

    }
  } else {
        showToast('error', "No file selected");

    // console.log("");
  }
});


//  getStudents()
//   var studentList = []
//  async function getStudents(){
//   if(schoolId == null){
//     console.log('empty')
//     return
//   }
  
//     var res= await axios.get(`http://localhost:3000/api/student/school/${schoolId}`)

  
//     console.log(res.data)
//       studentList = res.data;
//         const grnoVal = document.getElementById('grno')
//   grnoVal.innerHTML = studentList.length  + 1


//  }
//  console.log(studentList)

   var allComputerBatches = []
    async function loadComputerBatches(){
      if (!campusId) return;
      try {
        const url = `http://localhost:3000/api/batch/getAllComputerBatchesByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allComputerBatches = res.data.data;
        console.log(allComputerBatches)
        
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }

    var allEnglishBatches = []
     async function loadEnglishBatches(){
      if (!campusId) return;
      try {
        const url = `http://localhost:3000/api/batch/getAllEnglishBatchesByCampus/${user[0].school._id}/${campusId}`;
        const res = await axios.get(url);
        allEnglishBatches = res.data.data;
       
        
      } catch (err) {
        console.error("Error loading computer courses:", err);
      }
    }


  function showToast(type, message) {
      Swal.fire({
        toast: true,
        position: 'top-end',
        icon: type,
        title: message,
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
      });
    }
 function showLoader() {
    document.getElementById("loader").style.display = "flex";
  }

  // Hide loader
  function hideLoader() {
    document.getElementById("loader").style.display = "none";
  }

  // Auto show on page load
  window.addEventListener("load", () => {
    // Optional delay to simulate loading
    setTimeout(hideLoader, 300); // hide after 0.5s
  });
</script>
<script src="index.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  </body>

  </html>