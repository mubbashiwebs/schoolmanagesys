<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Subject Allotment - Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <link rel="stylesheet" href="index.css">

  <style>
    .minimalist-input {
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: none;
      font-size: 0.95rem;
      padding: 10px;
      transition: all 0.2s ease-in-out;
    }
    .minimalist-input:focus {
      border-color: #000;
      box-shadow: none;
    }
      
      .modal-header,
  .modal-footer {
    background: #f9f9f9;
  }
    .btn-dark {
      background-color: #000;
      border: none;
      border-radius: 8px;
    }
    .btn-dark:hover { background-color: #333; }
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1055; }
    .spinner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .table-scroll { max-height: 520px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container-fluid px-0">
        <div id="navContent"></div>

    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4 class="p-3">Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column p-2"></nav>
      </div>

           <div class="col  main-content ">
        
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-4 mb-5 border rounded-3">

              <h2 class="mb-4">Subject Allotments</h2>
              <div>
                <button class="btn btn-success mb-3" id="openAddBtn" data-bs-toggle="modal" data-bs-target="#subjectAllotmentModal">
                  <i class="fa fa-plus me-1"></i> Add Subject Allotment
                </button>
            </div>

            <div class="row g-2 align-items-end mb-3">
              <div class="col-md-4">
                <label class="form-label small">Search (class / subject / teacher)</label>
                <input id="searchInput" class="form-control minimalist-input minimalist-input" placeholder="Search by class, subject or teacher">
              </div>

              <div class="col-md-3" id="campusSelectBoxTop" style="display:none;">
                <label class="form-label small">Select Campus</label>
                <select id="campusDropdown" class="form-select minimalist-input"></select>
              </div>

              <div class="col-md-3">
                <label class="form-label small">Filter Class</label>
                <select id="filterClass" class="form-select minimalist-input"></select>
              </div>

              <div class="col-md-2">
                <label class="form-label small">Filter Section</label>
                <select id="filterSection" class="form-select minimalist-input"></select>
              </div>
            </div>

            <div class="table-responsive table-scroll">
              <table class="table table-bordered table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Class</th>
                    <th>Section</th>
                    <th>Subject</th>
                    <th>Teacher</th>
                    <th>Is Class Teacher?</th>
                    <th id="campusHeader" style="display:none;">Campus</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allotmentTableBody"></tbody>
              </table>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="subjectAllotmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content shadow-sm border-0 rounded-3">
        <form id="allotmentForm" class="p-0">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-semibold" id="modalTitle">Add Subject Allotment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="campusDropdownContainer" class="mb-3" style="display:none;">
              <label class="form-label small">Select Campus</label>
              <select id="modalCampusDropdown" class="form-select minimalist-input"></select>
            </div>

            <div class="row g-3 align-items-center">
              <div class="col-md-6">
                <label class="form-label small">Class</label>
                <select id="classId" class="form-select minimalist-input" required></select>
              </div>

              <div class="col-md-6">
                <label class="form-label small">Section</label>
                <select id="sectionId" class="form-select minimalist-input" required></select>
              </div>

              <div class="col-md-6">
                <label class="form-label small">Subject</label>
                <select id="subjectId" class="form-select minimalist-input" required></select>
              </div>

              <div class="col-md-6">
                <label class="form-label small">Teacher ID</label>
                <div class="input-group">
                  <input type="text" id="teacherIdInput" class="form-control minimalist-input " placeholder="Enter Teacher ID">
                  <button type="button" class="btn btn-outline-secondary" id="getTeacherBtn">
                    <span id="getTeacherSpinner" style="display:none;">
                      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    </span>
                    Get Teacher
                  </button>
                </div>
                <!-- <input type="hidden" id="teacherId">
                <input type="text" id="teacherName" class="form-control minimalist-input mt-2 minimalist-input" readonly placeholder="Teacher Name"> -->
              </div>

              <div class="col-md-6">
           <input type="hidden" id="teacherId">
                <input type="text" id="teacherName" class="form-control minimalist-input mt-2 minimalist-input" readonly placeholder="Teacher Name">
              </div>

              <div class="col-md-6 fs-4">
                <label class="form-label small">Is Class Teacher?</label>
                <input type="checkbox" id="isClassTeacher">
              </div>
            </div>
          </div>

          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-dark px-4" id="formSubmitBtn">
              <span id="formSpinner" style="display:none;">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </span>
              <span id="formBtnText">Allot</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div class="toast text-white border-0" id="toastMessage" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Message</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Global spinner overlay (for heavy load ops if needed) -->
  <div id="globalSpinner" class="spinner-overlay" style="display:none;">
    <div class="text-center">
      <div class="spinner-border" role="status" style="width:3rem;height:3rem;"></div>
      <div class="mt-2">Loading...</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // -------------------------
    // Configuration & state
    // -------------------------
    const user = JSON.parse(localStorage.getItem("userData")) || [];
    const isSuperAdmin = user[0]?.designation === "superemeadmin";
    let currentCampusId = user[0]?.campus?._id || '';
    let allotments = [];
    let originalAllotments = [];
    let classesList = [];
    let sectionsList = [];
    let subjectsList = [];

    // API endpoints (from your confirmation)
    const API_CLASS = (schoolId, campusId) => `http://202.143.127.181:3001/api/class/getByCampus/${schoolId}/${campusId}`;
    const API_SECTION = (schoolId, campusId) => `http://202.143.127.181:3001/api/section/getByCampus/${schoolId}/${campusId}`;
    const API_SUBJECT = (schoolId, campusId) => `http://202.143.127.181:3001/api/subject/getByCampus/${schoolId}/${campusId}`;
    const API_TEACHER = `http://202.143.127.181:3001/api/teacher/getById`;
    const API_SUBJECT_ALLOT = "http://202.143.127.181:3001/api/subject-allotments";

    // Elements
    const allotmentTbody = document.getElementById("allotmentTableBody");
    const toastEl = document.getElementById("toastMessage");
    const toastBody = document.getElementById("toastBody");
    const toast = new bootstrap.Toast(toastEl);
    const modalEl = document.getElementById("subjectAllotmentModal");
    const modal = new bootstrap.Modal(modalEl);
    const form = document.getElementById("allotmentForm");
    const formSubmitBtn = document.getElementById("formSubmitBtn");
    const formBtnText = document.getElementById("formBtnText");
    const formSpinner = document.getElementById("formSpinner");
    const getTeacherBtn = document.getElementById("getTeacherBtn");
    const getTeacherSpinner = document.getElementById("getTeacherSpinner");
    const globalSpinner = document.getElementById("globalSpinner");

    // Filters / inputs
    const campusDropdown = document.getElementById("campusDropdown");
    const modalCampusDropdown = document.getElementById("modalCampusDropdown");
    const campusSelectBoxTop = document.getElementById("campusSelectBoxTop");
    const campusDropdownContainer = document.getElementById("campusDropdownContainer");
    const campusHeader = document.getElementById("campusHeader");
    const filterClass = document.getElementById("filterClass");
    const filterSection = document.getElementById("filterSection");
    const searchInput = document.getElementById("searchInput");

    // Form inputs
    const classIdSelect = document.getElementById("classId");
    const sectionIdSelect = document.getElementById("sectionId");
    const subjectIdSelect = document.getElementById("subjectId");
    const teacherIdInput = document.getElementById("teacherIdInput");
    const teacherHidden = document.getElementById("teacherId");
    const teacherNameInput = document.getElementById("teacherName");
    const isClassTeacherCheckbox = document.getElementById("isClassTeacher");
    const modalTitle = document.getElementById("modalTitle");

    // -------------------------
    // Helpers
    // -------------------------
    function showToast(message, success = true) {
      toastBody.textContent = message;
      toastEl.classList.remove("bg-success", "bg-danger");
      toastEl.classList.add(success ? "bg-success" : "bg-danger");
      toast.show();
    }

    function toggleGlobalSpinner(show = true) {
      globalSpinner.style.display = show ? "flex" : "none";
    }

    function toggleFormLoading(show = true) {
      formSpinner.style.display = show ? "inline-block" : "none";
      formBtnText.style.display = show ? "none" : "inline-block";
      formSubmitBtn.disabled = show;
    }

    function toggleGetTeacherLoading(show = true) {
      getTeacherSpinner.style.display = show ? "inline-block" : "none";
      getTeacherBtn.disabled = show;
    }

    function fillSelect(selectEl, list, labelField = 'name', includeDefault = true) {
      if (!selectEl) return;
      selectEl.innerHTML = includeDefault ? '<option value="">Select</option>' : '';
      list.forEach(item => {
        const label = labelField.split('.').reduce((o,k)=>o?.[k], item) ?? item[labelField];
        selectEl.innerHTML += `<option value="${item._id}">${label}</option>`;
      });
    }

    // -------------------------
    // Data loading
    // -------------------------
    async function loadDropdownsForCampus(schoolId, campusId, forModal = true) {
      try {
        const [cRes, sRes, subRes] = await Promise.all([
          axios.get(API_CLASS(schoolId, campusId)),
          axios.get(API_SECTION(schoolId, campusId)),
          axios.get(API_SUBJECT(schoolId, campusId)),
        ]);

        classesList = cRes.data?.data ?? [];
        sectionsList = sRes.data?.data ?? [];
        subjectsList = subRes.data?.data ?? [];

        // fill modal selects
        fillSelect(classIdSelect, classesList, "name");
        fillSelect(sectionIdSelect, sectionsList, "name");
        fillSelect(subjectIdSelect, subjectsList, "name");

        // fill filter selects (top)
        fillSelect(filterClass, classesList, "name");
        fillSelect(filterSection, sectionsList, "name");
      } catch (err) {
        console.error("Error loading dropdowns:", err);
        showToast("Failed to load dropdown data", false);
      }
    }

    async function loadCampusesForSuperAdmin() {
      // If you maintain campus list endpoint, replace URL accordingly.
      // Here we assume campus list is under /api/campus/getBySchool/:schoolId
      try {
        const schoolId = user[0]?.school?._id;
        if (!schoolId) return;
        const res = await axios.get(`http://202.143.127.181:3001/api/campus/getBySchool/${schoolId}`);
        const campuses = res.data ?? [];
        // populate top and modal campus dropdown
        fillSelect(campusDropdown, campuses, "name");
        fillSelect(modalCampusDropdown, campuses, "name");
      } catch (err) {
        console.error("Failed to load campuses:", err);
        showToast("Failed to load campuses", false);
      }
    }

    async function loadAllotments() {
      try {
        toggleGlobalSpinner(true);
        // Optionally apply campus filter server-side if available
        const res = await axios.get(`${API_SUBJECT_ALLOT}`);
        allotments = res.data?.data ?? res.data ?? [];
        originalAllotments = [...allotments];
        renderAllotmentTable();
      } catch (err) {
        console.error("Failed to load allotments:", err);
        showToast("Failed to load allotments", false);
      } finally {
        toggleGlobalSpinner(false);
      }
    }

    // -------------------------
    // Rendering table
    // -------------------------
    function renderAllotmentTable(list = allotments) {
      allotmentTbody.innerHTML = "";
      if (!list || list.length === 0) {
        allotmentTbody.innerHTML = `<tr><td colspan="8" class="text-center">No allotments found</td></tr>`;
        return;
      }

      list.forEach((allot, idx) => {
        const teacherLabel = allot.teacherId ? (allot.teacherId.teacherName || allot.teacherId.name || allot.teacherId?.name) : "N/A";
        const isClassTeacher = allot.isClassTeacher ? "✅ Yes" : "❌ No";
        const campusName = allot.campusId?.name || (allot.classId?.campusId?.name) || "N/A";

        allotmentTbody.innerHTML += `
          <tr>
            <td>${idx+1}</td>
            <td>${allot.classId?.name ?? 'N/A'}</td>
            <td>${allot.sectionId?.name ?? 'N/A'}</td>
            <td>${allot.subjectId?.name ?? allot.subjectId?.name ?? 'N/A'}</td>
            <td>${teacherLabel}</td>
            <td>${isClassTeacher}</td>
            ${isSuperAdmin ? `<td>${campusName}</td>` : ''}
            <td>
              <button class="btn btn-sm btn-info me-1" onclick="editAllotment('${allot._id}')"><i class="fa fa-edit"></i></button>
              <button class="btn btn-sm btn-danger" onclick="deleteAllotment('${allot._id}')"><i class="fa fa-trash"></i></button>
            </td>
          </tr>
        `;
      });
    }

    // -------------------------
    // CRUD operations
    // -------------------------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      toggleFormLoading(true);
    const createdBy = user[0]._id

      const payload = {
        classId: classIdSelect.value,
        sectionId: sectionIdSelect.value,
        subjectId: subjectIdSelect.value,
        teacherId: teacherHidden.value || null,
        isClassTeacher: isClassTeacherCheckbox.checked,
        campusId: isSuperAdmin ? (modalCampusDropdown.value || null) : currentCampusId,
        createdBy

      };

      // basic validation
      if (!payload.classId || !payload.sectionId || !payload.subjectId) {
        showToast("Please select class, section and subject", false);
        toggleFormLoading(false);
        return;
      }

      try {
        const editId = form.editId;
        if (editId) {
          const res = await axios.put(`${API_SUBJECT_ALLOT}/${editId}`, payload);
          showToast(res.data?.message || "Allotment updated");
        } else {
          const res = await axios.post(`${API_SUBJECT_ALLOT}`, payload);
          showToast(res.data?.message || "Allotment created");
        }
        form.reset();
        form.editId = null;
        modal.hide();
        await loadAllotments();
      } catch (err) {
        console.error("Save allotment error:", err);
        showToast("Failed to save allotment", false);
      } finally {
        toggleFormLoading(false);
      }
    });

    window.editAllotment = async function(id) {
      try {
        toggleGlobalSpinner(true);
        const res = await axios.get(`${API_SUBJECT_ALLOT}/${id}`);
        const allot = res.data?.data ?? res.data;

        // If superadmin, set campus in modal and reload dropdowns for that campus
        if (isSuperAdmin) {
          modalCampusDropdown.value = allot.campusId?._id || '';
          await loadDropdownsForCampus(user[0].school._id, modalCampusDropdown.value || currentCampusId);
          campusDropdown.value = modalCampusDropdown.value || campusDropdown.value;
        } else {
          await loadDropdownsForCampus(user[0].school._id, currentCampusId);
        }

        classIdSelect.value = allot.classId?._id || '';
        sectionIdSelect.value = allot.sectionId?._id || '';
        subjectIdSelect.value = allot.subjectId?._id || '';
        teacherHidden.value = allot.teacherId?._id || '';
        teacherIdInput.value = allot.teacherId?.staffCode || '';
        teacherNameInput.value = allot.teacherId?.teacherName || allot.teacherId?.name || '';
        isClassTeacherCheckbox.checked = allot.isClassTeacher;

        form.editId = id;
        modalTitle.textContent = "Update Subject Allotment";
        formSubmitBtn.querySelector('#formBtnText').textContent = "Update";
        modal.show();
      } catch (err) {
        console.error("Failed to fetch allotment:", err);
        showToast("Failed to fetch allotment", false);
      } finally {
        toggleGlobalSpinner(false);
      }
    };

    window.deleteAllotment = async function(id) {
      if (!confirm("Are you sure you want to delete this allotment?")) return;
      try {
        toggleGlobalSpinner(true);
        const res = await axios.delete(`${API_SUBJECT_ALLOT}/${id}`);
        showToast(res.data?.message || "Deleted successfully");
        await loadAllotments();
      } catch (err) {
        console.error("Failed to delete allotment:", err);
        showToast("Failed to delete allotment", false);
      } finally {
        toggleGlobalSpinner(false);
      }
    };

    // -------------------------
    // Teacher fetch logic (Get Teacher)
    // -------------------------
    getTeacherBtn.addEventListener("click", async () => {
      const idVal = teacherIdInput.value.trim();
      if (!idVal) return alert("Enter teacher id");

      try {
        toggleGetTeacherLoading(true);
        // If your teacher endpoint requires school/campus in body, add them as earlier implementation did
        const payload = { id: idVal };
        const res = await axios.post(API_TEACHER, payload);
        const teacher = res.data?.data ?? res.data;
        if (!teacher) {
          showToast("Teacher not found", false);
          return;
        }
        teacherHidden.value = teacher._id;
        teacherNameInput.value = `${teacher.name || teacher.teacherName || ''} ${teacher.fatherName || ''}`.trim();
        showToast("Teacher loaded");
      } catch (err) {
        console.error("Failed to get teacher:", err);
        showToast("Failed to get teacher", false);
      } finally {
        toggleGetTeacherLoading(false);
      }
    });

    // -------------------------
    // Filters and search
    // -------------------------
    searchInput.addEventListener("input", () => applyFilters());
    filterClass.addEventListener("change", () => applyFilters());
    filterSection.addEventListener("change", () => applyFilters());

    function applyFilters() {
      const q = (searchInput.value || "").toLowerCase().trim();
      const selClass = filterClass.value;
      const selSection = filterSection.value;

      let filtered = originalAllotments.filter(a => {
        // campus filter if superadmin and campus dropdown top is used
        if (isSuperAdmin && campusDropdown.value) {
          if ((a.campusId?._id || a.campusId) !== campusDropdown.value) return false;
        }

        // class filter
        if (selClass && (a.classId?._id !== selClass)) return false;
        // section filter
        if (selSection && (a.sectionId?._id !== selSection)) return false;

        if (!q) return true;

        const className = (a.classId?.name || "").toLowerCase();
        const sectionName = (a.sectionId?.name || "").toLowerCase();
        const subjectName = (a.subjectId?.subjectName || a.subjectId?.name || "").toLowerCase();
        const teacherName = (a.teacherId?.teacherName || a.teacherId?.name || "").toLowerCase();

        return className.includes(q) || sectionName.includes(q) || subjectName.includes(q) || teacherName.includes(q);
      });

      allotments = filtered;
      renderAllotmentTable();
    }

    // When campus changes (superadmin), reload dropdowns and allotments
    campusDropdown?.addEventListener?.("change", async (e) => {
      const val = e.target.value;
      if (!val) return;
      currentCampusId = val;
      // reload dropdowns for top filters/modal
      await loadDropdownsForCampus(user[0].school._id, currentCampusId);
      // reload allotments from server or filter client-side if you prefer server-side
      await loadAllotments();
    });

    modalCampusDropdown?.addEventListener?.("change", async (e) => {
      const val = e.target.value;
      if (val) {
        await loadDropdownsForCampus(user[0].school._id, val);
      }
    });

    // Reset modal on close
    modalEl.addEventListener("hidden.bs.modal", () => {
      form.reset();
      form.editId = null;
      modalTitle.textContent = "Add Subject Allotment";
      formSubmitBtn.querySelector('#formBtnText').textContent = "Save";
      teacherHidden.value = '';
      teacherIdInput.value = '';
      teacherNameInput.value = '';
    });

    // -------------------------
    // Initialization
    // -------------------------
    (async function init() {
      // if no user stored -> redirect (similar to class form)
      if (!user || user.length === 0) {
        window.location.href = 'Dashboard.html';
        return;
      }

      // display superadmin controls if needed
      if (isSuperAdmin) {
        campusSelectBoxTop.style.display = 'block';
        campusDropdownContainer.style.display = 'block';
        campusHeader.style.display = 'table-cell';
        // load campuses dropdown then select first (or leave empty)
        await loadCampusesForSuperAdmin();
      } else {
        campusSelectBoxTop.style.display = 'none';
        campusDropdownContainer.style.display = 'none';
      }

      // load dropdowns for user's campus initially
      const schoolId = user[0].school._id;
      const campusToLoad = isSuperAdmin ? (modalCampusDropdown.value || currentCampusId) : currentCampusId;
      await loadDropdownsForCampus(schoolId, campusToLoad);

      // load allotments list
      await loadAllotments();

      // fill filter selects might be populated already
      applyFilters();
    })();

    // expose helper functions globally for table buttons
    window.loadAllotments = loadAllotments;
    window.renderAllotmentTable = renderAllotmentTable;

  </script>
  <script src="index.js"></script>
</body>
</html>
