<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - School form</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="index.css">
  <style>
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }
  
     html, body {
    height: 100%;
    overflow: hidden; /* prevents body scroll */
  }

  .main-content {
    height: 100vh;
    overflow-y: auto; /* allow scroll in content if needed */
    padding-right: 20px;
  }

  .modal-backdrop.show {
    opacity: 0.5;
  }

  .modal-dialog {
    margin: 0 auto;
  }

  /* Optional: Make modal height responsive */
  .modal-content {
    max-height: 90vh;
    overflow-y: auto;
  }
  label{
    font-weight: bolder;
  }
  .form-check-label{
    font-weight: normal;
  }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row flex-nowrap">
      <div class="col-auto col-md-3 col-xl-2 px-sm-2 px-0 sidebar">
        <h4>Admin Panel</h4>
        <nav id="sidebar" class="nav flex-column">
          <a href="./Dashboard.html">Dashboard</a>
          <a href="./schoolform.html" class="active">Add School</a>
          <a href="./classform.html">Add Class</a>
          <a href="./section.html">Add Section</a>
          <a href="./compcourse.html">Add Computer Course</a>
          <a href="./student.html">Student Form</a>
          <a href="./studentlist.html">Student List</a>
          <a href="./teacher.html">Teacher Form</a>
          <a href="./teacherlist.html">Teacher List</a>
          <a href="#">Logout</a>
        </nav>
      </div>

      <div class="col main-content">
        <div class="row justify-content-center align-items-center min-vh-100">
          <div class="col-10 bg-white p-5 mb-5 border rounded-3">
            <h2 class="mb-4">Add School</h2>
            <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addSchoolModal">Add New School</button>

            <h4>All Schools</h4>
            <input type="text" class="form-control w-50" placeholder="Serach By Name"  name="" id="searchSchool">

            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
              <table class="table table-bordered table-hover mt-3" id="classTable">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>School Name</th>
                    <th>Contact No</th>
                    <th>Address</th>
                    <th>Features</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Modal Form -->
<div class="modal fade" id="addSchoolModal" tabindex="-1" aria-labelledby="addSchoolModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="width: 100%; max-width: 600px; margin: auto;">
      <form id="schoolForm">
        <div class="modal-header">
          <h5 class="modal-title" id="addSchoolModalLabel">Add New School</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">School Name</label>
            <input type="text" class="form-control" id="schoolName" placeholder="Enter school name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Contact No</label>
            <input type="number" class="form-control" id="contactNo" placeholder="Enter contact number" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Address</label>
            <textarea class="form-control" id="address" rows="3" placeholder="Enter school address" required></textarea>
          </div>
          <div class="mb-3">
                               <label class="form-label">Features </label> <br>

                    <div class="form-check form-check-inline">
                      <input class="form-check-input features" type="checkbox" checked name="features" value="school" />
                      <label class="form-check-label">School</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input features" type="checkbox" name="features" value="tuition" />
                      <label class="form-check-label">Tuition</label>
                    </div>
                    <div class="form-check form-check-inline">
                      <input class="form-check-input features" type="checkbox" name="features" value="computer" />
                      <label class="form-check-label">Computer Class</label>
                    </div>
                    <div class="form-check form-check-inline features">
                      <input class="form-check-input" type="checkbox" name="features" value="english" />
                      <label class="form-check-label">English Language</label>
                    </div>
                  </div>

        </div>
        
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" id="formSubmitBtn">Add School</button>
        </div>
      </form>
    </div>
  </div>
</div>



<!-- ✅ Dynamic Toast Container -->
<div class="toast-container">
  <div class="toast text-white border-0" id="toastMessage" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">Message</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
   const schoolForm = document.getElementById("schoolForm");
   const checkboxes = document.querySelectorAll('.features')
const schoolNameInput = document.getElementById("schoolName");
const contactNoInput = document.getElementById("contactNo");
const addressInput = document.getElementById("address");
const tableBody = document.querySelector("#classTable tbody");
const modal = new bootstrap.Modal(document.getElementById("addSchoolModal"));
const formSubmitBtn = document.getElementById("formSubmitBtn");
const toast = new bootstrap.Toast(document.getElementById("toastMessage"));
const toastBody = document.getElementById("toastBody");
const toastElement = document.getElementById("toastMessage");
const searchSchoolInput = document.getElementById('searchSchool')

let isEditing = false;
let editingId = null;
let schools = [];
let originalSchools = [];   // ← full list for reference


const user = JSON.parse(localStorage.getItem('userData')) || [];
if (!user[0] || user[0].designation !== "superadmin") {
  showToast("Access Denied", false);
  window.location.href = "Dashboard.html";
}

// ✅ Reusable Toast Function
function showToast(message, isSuccess = true) {
  toastBody.textContent = message;
  toastElement.classList.remove("bg-success", "bg-danger");
  toastElement.classList.add(isSuccess ? "bg-success" : "bg-danger");
  toast.show();
}

// ✅ Load all schools
async function loadSchools() {
  try {
    const res = await axios.get("http://localhost:3000/api/school/get");
    schools = res.data.data;
    originalSchools = [...res.data.data]
    fillTable();
  } catch (err) {
    showToast("Error loading schools", false);
    console.error(err);
  }
}

// ✅ Fill table
function fillTable() {
  tableBody.innerHTML = "";
  if (schools.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center">No data found</td></tr>`;
    return;
  }

  schools.forEach((school, index) => {
    const row = document.createElement("tr");
    var features = school.features?.join(',') || 'N/A'
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${school.name}</td>
      <td>${school.contactNo}</td>
      <td>${school.address}</td>
      <td>${features || 'N/A'}</td>
      <td>
        <button class="btn btn-sm btn-success me-1 mb-2" onclick="editSchool('${school._id}')">edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteSchool('${school._id}')">Delete</button>
      </td>
    `;
    tableBody.appendChild(row);
  });
}

// ✅ Delete School
async function deleteSchool(id) {
  if (!confirm("Are you sure you want to delete this school?")) return;
  try {
    const res = await axios.delete(`http://localhost:3000/api/school/delete/${id}`);
    schools = schools.filter(s => s._id !== id)
    originalSchools = originalSchools.filter(os => os._id !== id)
    fillTable();
    showToast(res.data.message || "Deleted successfully");
  } catch (err) {
    console.error(err);
    showToast("Failed to delete school", false);
  }
}

// ✅ Edit School
window.editSchool = function (id) {
  const school = schools.find(s => s._id === id);
  if (!school) {
    showToast("School not found", false);
    return;
  }

  isEditing = true;
  editingId = id;
  schoolNameInput.value = school.name;
  contactNoInput.value = school.contactNo;
  addressInput.value = school.address;

  document.getElementById("addSchoolModalLabel").innerText = "Update School";
  formSubmitBtn.innerText = "Update School";
  modal.show();
};

// ✅ Add/Update School
schoolForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = schoolNameInput.value.trim();
  const contactNo = contactNoInput.value.trim();
  const address = addressInput.value.trim();
        const features= Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
  console.log(features)
  if (!name || !contactNo || !address || features.length <=0) {
    showToast("Please fill all fields", false);
    return;
  }

  try {
    if (isEditing) {
      const res = await axios.put(`http://localhost:3000/api/school/update/${editingId}`, {
        name, contactNo, address , features
      });

      const { data, message } = res.data;
      const index = schools.findIndex(s => s._id === editingId);
      schools[index] = data;
      originalSchools[index] = data

      showToast(message || "School updated successfully");

    } else {
      const res = await axios.post("http://localhost:3000/api/school/add", {
        name, contactNo, address , features
      });

      const { data, message } = res.data;
      showToast(message, data && data._id);

      // Only push if school added
      if (data && data._id) {
        schools.push(data);
        originalSchools.push(data)
      }
      console.log(schools)
      console.log(originalSchools)

      // Don't close modal if already exists
      if (message === "School Already Exists") return;
    }

    // Reset and close modal
    isEditing = false;
    editingId = null;
    schoolForm.reset();
    formSubmitBtn.textContent = "Add School";
    document.getElementById("addSchoolModalLabel").textContent = "Add New School";
    modal.hide();
    fillTable();

  } catch (err) {
    console.error(err);
    showToast("Failed to save school", false);
  }
});

document.getElementById("addSchoolModal").addEventListener("hidden.bs.modal", closeModal);


function closeModal() {
  schoolForm.reset();
  isEditing = false;
  editingId = null;
  formSubmitBtn.textContent = "Add School";
  document.getElementById("addSchoolModalLabel").textContent = "Add New School";
}

searchSchoolInput.addEventListener('input', () => {
  const searchTerm = searchSchoolInput.value.toLowerCase().trim();

  // Always filter from the original list
  const filteredSchools = originalSchools.filter(school =>
    school.name.toLowerCase().includes(searchTerm)
  );

  schools = filteredSchools;  // only use for display
  fillTable();                // re-render table
});



window.addEventListener("DOMContentLoaded", loadSchools);

  </script>
</body>
</html>
